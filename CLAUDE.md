# CLAUDE.md - Depyler Compiler Implementation Protocol

## Prime Directive
**Generate correct Rust code that compiles on first attempt. Quality is built-in, not bolted-on.**

## Project Context
Depyler is a Python-to-Rust transpiler focusing on energy-efficient, safe code generation with progressive verification.

## Python Packaging Protocol
**MANDATORY: Use `uv` for ALL Python operations**
- `uv add <package>` not pip install
- `uv run pytest` not python -m pytest
- `uv run <script.py>` not python3

## üö® CRITICAL: A+ Code Standard
**ABSOLUTE REQUIREMENTS**:
- Maximum Cyclomatic Complexity: ‚â§10
- Maximum Cognitive Complexity: ‚â§10
- Function Size: ‚â§30 lines
- Zero SATD (TODO/FIXME/HACK)
- TDD Mandatory
- Test Coverage: 80% minimum (cargo-llvm-cov)

## EXTREME TDD Protocol
**ANY TRANSPILER/CODEGEN BUG REQUIRES IMMEDIATE EXTREME TDD**:
1. HALT ALL OTHER WORK
2. Create comprehensive test suites (unit + integration + property + fuzz)
3. Add failing test BEFORE fixing
4. Validate all language features after fix

## EXTREME CLI VALIDATION
**15-Tool Validation Gates** (MANDATORY for ALL examples):
1. rustc --deny warnings
2. clippy -D warnings
3. rustfmt --check
4. Basic compilation
5-15. LLVM IR, ASM, MIR, parse, type check, cargo tree, rustdoc, macro expansion, HIR dump, dead code, complexity

**STOP THE LINE Protocol**: NEVER bypass gates. Fix transpiler, not output.

## Scientific Method Protocol
**WE DON'T GUESS, WE PROVE**:
1. NO ASSUMPTIONS - prove with tests
2. MEASURE EVERYTHING - use metrics
3. REPRODUCE ISSUES - minimal test cases
4. QUANTIFY IMPROVEMENTS - before/after
5. DOCUMENT EVIDENCE - reproducible steps

## QDD (Quality-Driven Development)
**Quality Metrics FIRST**:
```bash
# Before task
pmat tdg . --min-grade A- --format=json > baseline.json

# During development
pmat tdg dashboard --port 8080 --update-interval 5 &

# After each function
pmat tdg <file> --compare-baseline baseline.json

# Before commit
pmat tdg . --min-grade A- --fail-on-violation
```

## Development Principles
### Ëá™ÂÉçÂåñ (Jidoka) - Build Quality In
Never ship incomplete transpilation. Verification-first development.

### ÁèæÂú∞ÁèæÁâ© (Genchi Genbutsu) - Direct Observation
Test against real Rust. Measure actual compilation.

### ÂèçÁúÅ (Hansei) - Fix Before Adding
Fix broken functionality before new features.

### ÊîπÂñÑ (Kaizen) - Continuous Improvement
Incremental verification. Performance baselines.

## Critical Invariants
1. Type safety: Must pass `cargo check`
2. Determinism: Same input ‚Üí identical output
3. Memory safety: No UB or leaks

## Python‚ÜíRust Transpilation Workflow
```bash
# Transpile
depyler transpile <input.py>

# With verification
depyler transpile <input.py> --verify --gen-tests

# Validate
rustc --crate-type lib --deny warnings <output.rs>
```

**MANDATORY Header** in all .rs files:
```rust
// Generated by: depyler transpile <source.py>
// Source: <source.py>
```

## üõë STOP THE LINE: Validation-Driven Development
**When validation finds issues**:
1. üõë STOP - Don't continue
2. üìã DOCUMENT - Capture issue
3. üé´ TICKET - Create DEPYLER-XXXX
4. üîç ANALYZE - Root cause
5. üîß FIX TRANSPILER - Not output
6. ‚ôªÔ∏è RE-TRANSPILE ALL
7. ‚úÖ VERIFY - Confirm fix
8. ‚ñ∂Ô∏è RESUME

## Testing Strategy
### Multi-Level Testing (MANDATORY)
1. **Unit Tests**: ‚â•5 per module, 85% coverage
2. **Property Tests**: ‚â•3 per module, 1000 iterations each
3. **Doctests**: ‚â•2 per public function
4. **Integration Tests**: Full transpile‚Üícompile‚Üíexecute

### Mutation Testing
```bash
cargo mutants --workspace
# Target: ‚â•75% mutation kill rate
```

### Test Naming Convention
```rust
#[test]
fn test_DEPYLER_XXXX_<section>_<feature>_<scenario>() {}
```

## PMAT TDG Quality Enforcement (MANDATORY - BLOCKING)
**Before ANY code changes**:
```bash
pmat tdg . --min-grade A- --fail-on-violation
pmat quality-gate --fail-on-violation
```

**During development**:
```bash
pmat tdg <file.rs> --include-components --min-grade B+
pmat analyze complexity --max-cyclomatic 10 --fail-on-violation
pmat analyze satd --fail-on-violation
```

**Before commit (BLOCKING)**:
```bash
pmat tdg . --min-grade A- --fail-on-violation
pmat quality-gate --fail-on-violation --format=detailed
cargo llvm-cov --all-features --workspace --fail-under-lines 80
```

## MANDATORY: Roadmap and Ticket Tracking
1. **ALWAYS Use Ticket Numbers**: Every commit MUST reference DEPYLER-XXX
2. **Roadmap-First Development**: No work without roadmap entry
3. **Traceability**: All changes traceable via tickets

### Commit Message Format (MANDATORY)
```
[TICKET-ID] Brief description

Detailed explanation
- Improvements
- Tests added
- Performance impact

TDG Score Changes (MANDATORY):
- src/file.rs: 85.3‚Üí87.1 (B+‚ÜíA-) [+1.8]

PMAT Verification:
- Complexity: ‚â§10 ‚úÖ
- SATD: 0 ‚úÖ
- Coverage: 80.5% ‚Üí 82.1% ‚úÖ

Closes: TICKET-ID
```

## MANDATORY Quality Gates (BLOCKING)
### RED-GREEN-REFACTOR Workflow
**Phase 1: RED** (Write failing tests)
```bash
cargo test test_DEPYLER_XXXX  # MUST FAIL
git commit --no-verify -m "[RED] DEPYLER-XXXX: Add failing tests"
```

**Phase 2: GREEN** (Minimal implementation)
```bash
cargo test test_DEPYLER_XXXX  # MUST PASS
git commit -m "[GREEN] DEPYLER-XXXX: Implement <feature>"
```

**Phase 3: REFACTOR** (Meet quality standards)
```bash
pmat tdg . --min-grade A- --fail-on-violation
pmat analyze complexity --max-cyclomatic 10 --fail-on-violation
cargo clippy --all-targets -- -D warnings
cargo llvm-cov report --fail-under-lines 80
git commit -m "[REFACTOR] DEPYLER-XXXX: Meet quality standards"
```

### Pre-commit Hooks (MANDATORY)
**Quality Gates**:
- Documentation synchronization (roadmap.md + CHANGELOG.md)
- Complexity ‚â§10 (pmat analyze complexity)
- Zero SATD (pmat analyze satd)
- TDG grade A- (pmat tdg)
- Coverage ‚â•80% (cargo-llvm-cov)
- Clippy warnings (cargo clippy -- -D warnings)

**SACRED RULE**: NEVER `git commit --no-verify` (except RED phase)

## The Make Lint Contract
```bash
cargo clippy --all-targets --all-features -- -D warnings
```
`-D warnings` treats EVERY clippy warning as hard error. Zero technical debt tolerance.

## Sprint Hygiene
**Pre-Sprint Cleanup**:
```bash
rm -f test_* debug_*
find . -type f -executable -not -path "./target/*" -delete
cargo clean
```

## The Development Flow (PMAT-Enforced)
1. BASELINE: `pmat quality-gate --fail-on-violation`
2. LOCATE: Find task in roadmap.yaml
3. VERIFY: Check dependencies complete
4. WRITE: Property test FIRST (TDD)
5. IMPLEMENT: <10 complexity (`pmat analyze complexity`)
6. VERIFY: Generated Rust compiles
7. VALIDATE: `pmat quality-gate` before commit
8. COVERAGE: ‚â•80% (`cargo llvm-cov`)
9. COMMIT: With ticket reference (only if ALL gates pass)

## Release Checklist
- [ ] All examples transpile and run
- [ ] Property tests 100% coverage on supported features
- [ ] Generated code passes clippy -D warnings
- [ ] No performance regression
- [ ] Documentation examples tested
- [ ] CHANGELOG updated
- [ ] Version bump (semver)

---

**Remember**: Perfect transpilation > feature-complete transpilation. Every line of generated Rust must be idiomatic. Ship nothing that doesn't meet these standards.
