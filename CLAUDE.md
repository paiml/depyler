# CLAUDE.md - Depyler Compiler Implementation Protocol

## Prime Directive
**Generate correct Rust code that compiles on first attempt. Quality is built-in, not bolted-on.**

## Project Context
Depyler is a Python-to-Rust transpiler focusing on energy-efficient, safe code generation with progressive verification.

## Python Packaging Protocol
**MANDATORY: Use `uv` for ALL Python operations**
- `uv add <package>` not pip install
- `uv run pytest` not python -m pytest
- `uv run <script.py>` not python3

## üö® CRITICAL: A+ Code Standard
**ABSOLUTE REQUIREMENTS**:
- Maximum Cyclomatic Complexity: ‚â§10
- Maximum Cognitive Complexity: ‚â§10
- Function Size: ‚â§30 lines
- Zero SATD (TODO/FIXME/HACK)
- TDD Mandatory
- Test Coverage: 80% minimum (cargo-llvm-cov)

## EXTREME TDD Protocol
**ANY TRANSPILER/CODEGEN BUG REQUIRES IMMEDIATE EXTREME TDD**:
1. HALT ALL OTHER WORK
2. Create comprehensive test suites (unit + integration + property + fuzz)
3. Add failing test BEFORE fixing
4. Validate all language features after fix

## EXTREME CLI VALIDATION
**15-Tool Validation Gates** (MANDATORY for ALL examples):
1. rustc --deny warnings
2. clippy -D warnings
3. rustfmt --check
4. Basic compilation
5-15. LLVM IR, ASM, MIR, parse, type check, cargo tree, rustdoc, macro expansion, HIR dump, dead code, complexity

**STOP THE LINE Protocol**: NEVER bypass gates. Fix transpiler, not output.

## Scientific Method Protocol
**WE DON'T GUESS, WE PROVE**:
1. NO ASSUMPTIONS - prove with tests
2. MEASURE EVERYTHING - use metrics
3. REPRODUCE ISSUES - minimal test cases
4. QUANTIFY IMPROVEMENTS - before/after
5. DOCUMENT EVIDENCE - reproducible steps

## Debugging Toolkit
**MANDATORY: Use system-level tracing for runtime behavior analysis**

### Renacer - Pure Rust System Call Tracer
**Location**: `/home/noah/src/renacer/target/debug/renacer`

**Use Cases**:
- Debug transpiled Rust binary runtime behavior
- Identify syscall issues in generated code
- Correlate syscalls with source code (DWARF debug info)
- Profile syscall timing and frequency

**Basic Usage**:
```bash
# Trace all syscalls
/home/noah/src/renacer/target/debug/renacer -- ./target/debug/my_binary

# Filter specific syscalls (file operations)
/home/noah/src/renacer/target/debug/renacer -e trace=file -- ./target/debug/my_binary

# Show syscall timing
/home/noah/src/renacer/target/debug/renacer -T -- ./target/debug/my_binary

# Statistics summary
/home/noah/src/renacer/target/debug/renacer -c -- ./target/debug/my_binary

# Source correlation (with debug info)
/home/noah/src/renacer/target/debug/renacer -s -- ./target/debug/my_binary

# JSON output for parsing
/home/noah/src/renacer/target/debug/renacer --format json -- ./target/debug/my_binary
```

**Debugging Workflow**:
1. Transpile Python to Rust with debug info: `depyler transpile --debug <file.py>`
2. Build Rust binary: `rustc -g <output.rs>` or `cargo build`
3. Trace execution: `renacer -s -T -- ./binary`
4. Analyze syscalls to identify runtime issues
5. Fix transpiler based on findings

**Quick Alias** (add to shell):
```bash
alias renacer='/home/noah/src/renacer/target/debug/renacer'
```

**Example - Debug transpiled code**:
```bash
# Transpile Python
depyler transpile my_script.py -o my_script.rs

# Compile with debug info
rustc -g my_script.rs -o my_script

# Trace execution with timing
renacer -T -- ./my_script

# Get statistics summary
renacer -c -- ./my_script

# Focus on file operations
renacer -e trace=file -- ./my_script
```

## QDD (Quality-Driven Development)
**Quality Metrics FIRST**:
```bash
# Before task
pmat tdg . --min-grade A- --format=json > baseline.json

# During development
pmat tdg dashboard --port 8080 --update-interval 5 &

# After each function
pmat tdg <file> --compare-baseline baseline.json

# Before commit
pmat tdg . --min-grade A- --fail-on-violation
```

## Development Principles
### Ëá™ÂÉçÂåñ (Jidoka) - Build Quality In
Never ship incomplete transpilation. Verification-first development.

### ÁèæÂú∞ÁèæÁâ© (Genchi Genbutsu) - Direct Observation
Test against real Rust. Measure actual compilation.

### ÂèçÁúÅ (Hansei) - Fix Before Adding
Fix broken functionality before new features.

### ÊîπÂñÑ (Kaizen) - Continuous Improvement
Incremental verification. Performance baselines.

## Critical Invariants
1. Type safety: Must pass `cargo check`
2. Determinism: Same input ‚Üí identical output
3. Memory safety: No UB or leaks

## Python‚ÜíRust Transpilation Workflow
```bash
# Transpile
depyler transpile <input.py>

# With verification
depyler transpile <input.py> --verify --gen-tests

# Validate
rustc --crate-type lib --deny warnings <output.rs>
```

**MANDATORY Header** in all .rs files:
```rust
// Generated by: depyler transpile <source.py>
// Source: <source.py>
```

## üõë STOP THE LINE: MANDATORY Bug-Fix Protocol (NON-NEGOTIABLE)

**ABSOLUTE REQUIREMENT - NOT OPTIONAL**: When ANY defect is discovered in transpiled output, **STOP ALL WORK IMMEDIATELY**. This protocol is MANDATORY and cannot be bypassed, deferred, or delegated.

### Why This Exists
Every transpiler bug affects ALL future code generated. Fixing bugs immediately prevents:
- Technical debt accumulation
- Cascading failures in downstream projects
- Loss of user trust
- Compounding maintenance costs

### The 8-Step Protocol (MANDATORY - NO EXCEPTIONS)

1. **üõë STOP THE LINE** - Halt ALL feature work immediately
   - Do not "finish this one thing first"
   - Do not "just commit what I have"
   - STOP means STOP

2. **üìã DOCUMENT THE BUG** - Create comprehensive bug document
   - File: `docs/bugs/DEPYLER-XXXX-<description>.md`
   - Template: See DEPYLER-0279, DEPYLER-0280 examples
   - Must include: Problem, Root Cause, Solution, Test Plan
   - Minimum 200 lines of analysis (comprehensive is required)

3. **üé´ ASSIGN TICKET NUMBER** - Sequential DEPYLER-XXXX
   - Check last ticket number in `docs/bugs/`
   - Increment by 1
   - Update roadmap.yaml with ticket reference

4. **üîç ROOT CAUSE ANALYSIS** - Find transpiler bug source
   - Never blame "user error" - transpiler must handle it
   - Locate exact file + line number in transpiler
   - Understand WHY the bug exists (not just WHAT)

5. **üîß FIX THE TRANSPILER** - NEVER fix generated output
   - SACRED RULE: Fix the generator, not the generated code
   - Add regression test BEFORE implementing fix
   - Ensure fix meets all quality gates (‚â§10 complexity)

6. **‚ôªÔ∏è RE-TRANSPILE EVERYTHING** - Regenerate ALL affected files
   - Matrix Testing Project examples
   - Showcase examples
   - Documentation examples
   - Any other transpiled code

7. **‚úÖ VERIFY COMPREHENSIVELY** - All quality gates must pass
   - Transpiled code compiles (rustc --deny warnings)
   - All tests pass (cargo test)
   - Quality gates pass (pmat, clippy, llvm-cov)
   - No regressions in other examples

8. **‚ñ∂Ô∏è RESUME WORK** - Only after 100% verification
   - Update CLAUDE.md if protocol improved
   - Document lessons learned
   - Continue previous work

### Enforcement

**This protocol is MANDATORY and enforced by**:
- GitHub issue templates
- Pre-commit hooks
- Code review requirements
- CI/CD pipeline gates

**Violations Result In**:
- Commit rejection
- PR block
- Build failure

**NO EXCEPTIONS** - Even for:
- "Quick fixes" ‚ùå
- "Just this once" ‚ùå
- "We'll fix it later" ‚ùå
- "It's only a warning" ‚ùå

### Examples

**CORRECT** ‚úÖ:
```
Discover bug ‚Üí STOP ‚Üí Document ‚Üí Fix transpiler ‚Üí Re-transpile ‚Üí Verify ‚Üí Resume
Timeline: 2-4 hours of focused work
Result: Bug fixed forever, all code benefits
```

**INCORRECT** ‚ùå:
```
Discover bug ‚Üí "Note it for later" ‚Üí Continue feature work
Result: Bug persists, affects all new code, technical debt grows
```

### Recent Examples

- **DEPYLER-0279**: Dict codegen bugs (2 issues fixed, 419-line doc)
- **DEPYLER-0280**: Duplicate mod tests (1 issue fixed, 582-line doc)

Both followed this protocol religiously. See `docs/bugs/` for templates.

### Full Protocol Document

Detailed procedures: [docs/processes/stop-the-line.md](docs/processes/stop-the-line.md)

**Defect Severity Classification**:
- **P0 (STOP ALL WORK)**: Compilation failures, type safety violations, memory safety issues
- **P1 (BLOCK RELEASE)**: Clippy warnings, non-idiomatic code, performance regressions
- **P2/P3 (TRACK)**: Optimization opportunities, documentation gaps

## Testing Strategy
### Multi-Level Testing (MANDATORY)
1. **Unit Tests**: ‚â•5 per module, 85% coverage
2. **Property Tests**: ‚â•3 per module, 1000 iterations each
3. **Doctests**: ‚â•2 per public function
4. **Integration Tests**: Full transpile‚Üícompile‚Üíexecute

### Mutation Testing
```bash
cargo mutants --workspace
# Target: ‚â•75% mutation kill rate
```

### Test Naming Convention
```rust
#[test]
fn test_DEPYLER_XXXX_<section>_<feature>_<scenario>() {}
```

## PMAT TDG Quality Enforcement (MANDATORY - BLOCKING)

### TDG (Technical Debt Grading) Overview
TDG is PMAT's comprehensive quality metric that quantifies technical debt on a 0-5 scale:
- **0.0-1.5**: Excellent (A+/A)
- **1.5-2.0**: Good (A-/B+)
- **2.0-2.5**: Acceptable (B/B-)
- **2.5-3.5**: Warning (C)
- **3.5+**: Critical (D/F) - BLOCKS COMMITS

**Workspace Policy** (from Cargo.toml):
```toml
[workspace.metadata.quality]
max_tdg_score = 2.0  # Any file above = technical debt violation
```

### TDG Command Reference
**IMPORTANT**: Use `pmat analyze tdg` (not `pmat tdg`):
```bash
# Full project analysis with component breakdown
pmat analyze tdg --path . --threshold 2.0 --include-components

# Critical files only (TDG > 2.5)
pmat analyze tdg --path crates --critical-only

# Top 10 debt hotspots
pmat analyze tdg --path . --top-files 10 --format table

# JSON output for automation
pmat analyze tdg --path . --format json > tdg_report.json
```

### Git-Enforced TDG Quality Gates
**Pre-commit hook enforcement** (`.git/hooks/pre-commit`):
- **Scope**: Only `crates/` directory (optimized for performance)
- **Threshold**: TDG ‚â§ 2.0 (from workspace config)
- **Timeout**: 30 seconds (skips if exceeded)
- **Blocking**: Fails commit if critical files found (TDG > 2.5)

**Current Status** (as of 2025-10-29):
- **Total Files (crates/)**: 188
- **Critical Files**: 0 (0.0%) ‚úÖ
- **Warning Files**: 7 (3.7%)
- **Average TDG**: 0.70
- **95th Percentile**: 1.45
- **99th Percentile**: 1.79
- **Estimated Debt**: 576.9 hours

### TDG Development Workflow
**Before ANY code changes**:
```bash
# Baseline analysis
pmat analyze tdg --path crates --threshold 2.0 --include-components

# Quality gate check
pmat quality-gate --fail-on-violation
```

**During development** (after each function/module):
```bash
# File-level TDG
pmat analyze tdg --path <file.rs> --include-components

# Traditional complexity (backup)
pmat analyze complexity --file <file.rs> --max-cyclomatic 10 --fail-on-violation

# SATD zero-tolerance
pmat analyze satd --path <file.rs> --fail-on-violation
```

**Before commit (MANDATORY - BLOCKS COMMITS)**:
```bash
# TDG threshold enforcement (automated in pre-commit hook)
pmat analyze tdg --path crates --threshold 2.0 --critical-only

# Comprehensive quality gate
pmat quality-gate --fail-on-violation --format=detailed

# Coverage enforcement
cargo llvm-cov --all-features --workspace --fail-under-lines 80
```

## MANDATORY: Roadmap and Ticket Tracking
1. **ALWAYS Use Ticket Numbers**: Every commit MUST reference DEPYLER-XXX
2. **Roadmap-First Development**: No work without roadmap entry
3. **Traceability**: All changes traceable via tickets

### Commit Message Format (MANDATORY)
```
[TICKET-ID] Brief description

Detailed explanation
- Improvements
- Tests added
- Performance impact

TDG Score Changes (MANDATORY):
- src/file.rs: 85.3‚Üí87.1 (B+‚ÜíA-) [+1.8]

PMAT Verification:
- Complexity: ‚â§10 ‚úÖ
- SATD: 0 ‚úÖ
- Coverage: 80.5% ‚Üí 82.1% ‚úÖ

Closes: TICKET-ID
```

## MANDATORY Quality Gates (BLOCKING)
### RED-GREEN-REFACTOR Workflow
**Phase 1: RED** (Write failing tests)
```bash
cargo test test_DEPYLER_XXXX  # MUST FAIL
git commit --no-verify -m "[RED] DEPYLER-XXXX: Add failing tests"
```

**Phase 2: GREEN** (Minimal implementation)
```bash
cargo test test_DEPYLER_XXXX  # MUST PASS
git commit -m "[GREEN] DEPYLER-XXXX: Implement <feature>"
```

**Phase 3: REFACTOR** (Meet quality standards)
```bash
pmat tdg . --min-grade A- --fail-on-violation
pmat analyze complexity --max-cyclomatic 10 --fail-on-violation
cargo clippy --all-targets -- -D warnings
cargo llvm-cov report --fail-under-lines 80
git commit -m "[REFACTOR] DEPYLER-XXXX: Meet quality standards"
```

### Pre-commit Hooks (MANDATORY)
**Quality Gates** (`.git/hooks/pre-commit`):
1. **Documentation Synchronization**: roadmap.md + CHANGELOG.md must be updated with code changes
2. **Complexity Enforcement**: ‚â§10 cyclomatic/cognitive (`pmat analyze complexity --max-cyclomatic 10`)
3. **SATD Zero-Tolerance**: No TODO/FIXME/HACK (`pmat analyze satd --fail-on-violation`)
4. **TDG Threshold**: ‚â§2.0 project-wide (`pmat analyze tdg --path crates --threshold 2.0 --critical-only`)
5. **Coverage Minimum**: ‚â•80% (`cargo llvm-cov --fail-under-lines 80`)
6. **Clippy Zero-Warnings**: All warnings = errors (`cargo clippy -- -D warnings`)
7. **Dead Code Detection**: `pmat analyze dead-code` (30s timeout)
8. **Duplicate Code**: `pmat analyze duplicates --threshold 0.8` (15s timeout)

**SACRED RULE**: NEVER `git commit --no-verify` (except RED phase in TDD)

**Performance Optimizations**:
- TDG: Only analyzes `crates/` directory (not examples/playground) with 30s timeout
- Dead Code: Only changed files, 30s timeout
- Duplicates: Only `crates/` directory, 15s timeout

## The Make Lint Contract
```bash
cargo clippy --all-targets --all-features -- -D warnings
```
`-D warnings` treats EVERY clippy warning as hard error. Zero technical debt tolerance.

## Sprint Hygiene
**Pre-Sprint Cleanup**:
```bash
rm -f test_* debug_*
find . -type f -executable -not -path "./target/*" -delete
cargo clean
```

## The Development Flow (PMAT-Enforced)
1. BASELINE: `pmat quality-gate --fail-on-violation`
2. LOCATE: Find task in roadmap.yaml
3. VERIFY: Check dependencies complete
4. WRITE: Property test FIRST (TDD)
5. IMPLEMENT: <10 complexity (`pmat analyze complexity`)
6. VERIFY: Generated Rust compiles
7. VALIDATE: `pmat quality-gate` before commit
8. COVERAGE: ‚â•80% (`cargo llvm-cov`)
9. COMMIT: With ticket reference (only if ALL gates pass)

## üîç Renacer Debugging Integration (Performance Profiling)

**Tool**: [Renacer v0.2.0+](https://github.com/paiml/renacer) - Syscall tracer and function profiler
**Install**: `cargo install renacer`

### When to Use Renacer

**MANDATORY** for performance-critical work:
- ‚ùå NEVER optimize without profiling first (no guessing!)
- ‚úÖ ALWAYS profile before claiming "performance improvement"
- ‚úÖ REQUIRED for any commit mentioning "optimization", "faster", or "performance"

### Quick Start Scripts

**Profile Transpiler**:
```bash
# Basic profiling
./scripts/profile_transpiler.sh examples/benchmark.py

# Generate flamegraph
./scripts/profile_transpiler.sh examples/matrix_testing_project/07_algorithms/algorithms.py --flamegraph

# Find I/O bottlenecks only
./scripts/profile_transpiler.sh examples/example_stdlib.py --io-only
```

**Profile Tests**:
```bash
# Find slow tests (>100ms)
./scripts/profile_tests.sh --slow-only

# Profile specific test
./scripts/profile_tests.sh cargo_toml_gen

# Full test suite profiling
./scripts/profile_tests.sh
```

**Profile DEPYLER-0384 (Cargo.toml Generation)**:
```bash
# Comprehensive profiling of automatic dependency tracking
./scripts/profile_cargo_toml_gen.sh
```

### Performance Thresholds (ENFORCED)

**Transpilation Performance**:
- Parse phase: <50ms for typical scripts
- Codegen phase: <100ms for typical scripts
- Total transpilation: <200ms for typical scripts

**I/O Thresholds**:
- File read: <10ms (use buffering if exceeded)
- File write: <5ms (acceptable for Cargo.toml generation)
- Temp file operations: <1ms per operation

**Test Performance**:
- Unit tests: <10ms each
- Property tests: <100ms total (1000 iterations)
- Integration tests: <500ms each (compilation allowed)

### Profiling Workflow (Scientific Method)

**MANDATORY steps for optimization commits**:

1. **BASELINE** - Establish current performance
   ```bash
   renacer --function-time -- cargo run --release -- transpile script.py > baseline.txt
   ```

2. **IDENTIFY** - Find hot functions (>5% total time)
   ```bash
   ./scripts/profile_transpiler.sh script.py --hot-functions
   ```

3. **HYPOTHESIZE** - Form optimization hypothesis
   - Example: "Caching type lookups will reduce parser time by 30%"

4. **OPTIMIZE** - Apply targeted optimization
   - ONLY optimize hot paths identified in step 2
   - NEVER optimize without profiling data

5. **MEASURE** - Verify improvement
   ```bash
   renacer --function-time -- cargo run --release -- transpile script.py > optimized.txt
   diff baseline.txt optimized.txt
   ```

6. **VALIDATE** - Ensure correctness maintained
   ```bash
   cargo test --workspace
   cargo clippy -- -D warnings
   ```

### Commit Message Requirements

For performance-related commits, MUST include:
```
[DEPYLER-XXXX] Optimize parser caching (30% speedup)

Performance Metrics (Renacer v0.2.0):
  Baseline:
    - parse_python: 45.3ms (23%)
    - Total: 196ms

  Optimized:
    - parse_python: 31.7ms (16%) [-30%]
    - Total: 167ms [-15%]

  I/O Bottlenecks:
    - Before: File read 12.3ms
    - After: Buffered read 2.1ms [-83%]

Verification:
  - Tests: 690/690 passing ‚úÖ
  - Flamegraph: attached (depyler_optimized.svg)
  - No regressions ‚úÖ
```

### Example: DEPYLER-0384 Profiling

```bash
# Profile Cargo.toml generation overhead
./scripts/profile_cargo_toml_gen.sh

# Expected results:
#   - extract_dependencies: <0.2ms
#   - generate_cargo_toml: <0.1ms
#   - Total overhead: <1% of transpilation time ‚úÖ
```

### Flamegraph Best Practices

**Prerequisites**:
```bash
git clone https://github.com/brendangregg/FlameGraph
export PATH=$PATH:$PWD/FlameGraph
```

**Generate flamegraph**:
```bash
renacer --function-time -- cargo run --release -- transpile large_script.py | \
    flamegraph.pl > transpile_flame.svg
```

**Attach to commits**: Include flamegraphs in optimization PRs

### Debugging Scenarios

**Slow transpilation**:
```bash
./scripts/profile_transpiler.sh slow_script.py --flamegraph
depyler transpile slow_script.py --trace  # See pipeline phases
```

**Compilation timeout**:
```bash
renacer --function-time -- depyler compile timeout_script.py
```

**Test regression**:
```bash
./scripts/profile_tests.sh failing_test
```

**Full Documentation**: [docs/debugging/renacer-debugging-guide.md](docs/debugging/renacer-debugging-guide.md)

## Release Checklist
- [ ] All examples transpile and run
- [ ] Property tests 100% coverage on supported features
- [ ] Generated code passes clippy -D warnings
- [ ] No performance regression
- [ ] Documentation examples tested
- [ ] CHANGELOG updated
- [ ] Version bump (semver)

## üìÖ Release Cadence (MANDATORY)

**CRITICAL RULE**: NEVER release to crates.io until FRIDAY. We ONLY release once per week.

**Release Schedule**:
- **Release Day**: Friday only
- **Frequency**: Once per week maximum
- **No Exceptions**: Emergency fixes wait until Friday

**Rationale**:
- Allows full week for testing and validation
- Prevents rushed releases
- Ensures quality over speed
- Gives users predictable update schedule

**Process**:
1. **Monday-Thursday**: Development, testing, bug fixes
2. **Thursday EOD**: Freeze code, final validation
3. **Friday**: Release to crates.io if all gates pass
4. **Weekend**: Monitor for issues

**Violations**:
- ‚ùå NO mid-week releases
- ‚ùå NO "hotfix" releases (wait for Friday)
- ‚ùå NO multiple releases per week

---

**Remember**: Perfect transpilation > feature-complete transpilation. Every line of generated Rust must be idiomatic. Ship nothing that doesn't meet these standards.
