#!/bin/bash
# Depyler Pre-commit Quality Gates
# Based on ruchy and paiml-mcp-agent-toolkit standards

set -e

echo "ğŸ” Depyler Quality Gates - Checking documentation synchronization..."

# Documentation files that MUST be updated with code changes
REQUIRED_DOCS=(
    "docs/execution/roadmap.md"
    "CHANGELOG.md"
)

# Check if any Rust/source files are being committed
if git diff --cached --name-only | grep -qE '\.(rs)$'; then
    echo "ğŸ“ Source changes detected - verifying documentation updates..."

    # Ensure at least one documentation file is updated
    DOC_UPDATED=false
    for doc in "${REQUIRED_DOCS[@]}"; do
        if git diff --cached --name-only | grep -q "$doc"; then
            DOC_UPDATED=true
            echo "âœ“ Found documentation update: $doc"
            break
        fi
    done

    if [ "$DOC_UPDATED" = false ]; then
        echo "âŒ ERROR: Code changes require documentation updates!"
        echo "ğŸ“‹ Must update at least one of:"
        for doc in "${REQUIRED_DOCS[@]}"; do
            echo "   - $doc"
        done
        echo ""
        echo "ğŸ’¡ Quick fix:"
        echo "   1. Update docs/execution/roadmap.md with task status"
        echo "   2. Update CHANGELOG.md with feature/fix"
        echo ""
        echo "ğŸ¯ Toyota Way: Documentation synchronization ensures quality at source"
        exit 1
    fi
fi

# Verify roadmap.md structure
if git diff --cached --name-only | grep -q "docs/execution/roadmap.md"; then
    # Check for task IDs and completion markers
    ROADMAP=$(git show :docs/execution/roadmap.md 2>/dev/null || cat docs/execution/roadmap.md)

    # Ensure task ID format (DEPYLER-XXXX)
    if ! echo "$ROADMAP" | grep -qE 'DEPYLER-[0-9]{4}'; then
        echo "âš ï¸  Warning: roadmap.md should use DEPYLER-XXXX task ID format"
    fi

    # Check for status markers
    if ! echo "$ROADMAP" | grep -qE '\[[ x]\]'; then
        echo "âš ï¸  Warning: roadmap.md should include [x] completion markers"
    fi

    echo "âœ“ Roadmap.md structure validated"
fi

# Run PMAT quality checks on staged files (Toyota Way Jidoka)
echo "ğŸ”§ Running PMAT quality analysis (Toyota Way Jidoka)..."

QUALITY_VIOLATIONS=0

for file in $(git diff --cached --name-only --diff-filter=A | grep -E '\.rs$'); do
    echo "  Checking $file (new file - strict enforcement)..."

    # Skip target directory and test files (production code only)
    if [[ "$file" == target/* ]] || [[ "$file" == **/tests/* ]] || [[ "$file" == *_test.rs ]]; then
        echo "    âŠ˜ Skipped (target/test file)"
        continue
    fi

    # Complexity check using PMAT
    if command -v pmat &> /dev/null; then
        echo "    Running complexity analysis..."
        if ! pmat analyze complexity --file "$file" --max-cyclomatic 10 --max-cognitive 10 --fail-on-violation &>/dev/null; then
            echo "    âŒ Complexity violation in $file (exceeds Toyota Way standards: â‰¤10)"
            echo "    ğŸ”§ Fix: pmat refactor auto --file $file"
            QUALITY_VIOLATIONS=$((QUALITY_VIOLATIONS + 1))
        else
            echo "    âœ“ Complexity check passed (â‰¤10)"
        fi

        # SATD check (zero tolerance)
        echo "    Running SATD analysis..."
        if ! pmat analyze satd --path "$file" --fail-on-violation &>/dev/null; then
            echo "    âŒ SATD violation in $file (zero tolerance policy)"
            echo "    ğŸ”§ Fix: Remove all TODO/FIXME/HACK comments"
            QUALITY_VIOLATIONS=$((QUALITY_VIOLATIONS + 1))
        else
            echo "    âœ“ SATD check passed (zero debt)"
        fi
    else
        echo "    âš ï¸  PMAT binary not found, skipping quality checks"
        echo "    ğŸ’¡ Install: cargo install pmat"
    fi
done

# Skip TDG grade check (pmat tdg command doesn't exist in pmat 2.4.0)
# Project-wide TDG is tracked separately via: pmat analyze tdg --path . --include-components
# Per-file complexity enforcement (above) provides granular quality gates

# Check for Rust linting if we have Rust files
if git diff --cached --name-only | grep -qE '\.rs$'; then
    echo "ğŸ”§ Running Rust linting..."
    if cargo clippy --quiet --all-targets --all-features -- -D warnings &>/dev/null; then
        echo "  âœ“ Clippy checks passed (zero warnings)"
    else
        echo "  âŒ Clippy violations found"
        echo "  ğŸ”§ Fix: cargo clippy --fix && cargo fmt"
        QUALITY_VIOLATIONS=$((QUALITY_VIOLATIONS + 1))
    fi
fi

# Coverage check (cargo-llvm-cov) - only if available
if command -v cargo-llvm-cov &> /dev/null; then
    echo "ğŸ“Š Running coverage check..."
    COVERAGE=$(cargo llvm-cov --all-features --workspace --summary-only 2>/dev/null | grep -oP '\d+\.\d+%' | head -1 | sed 's/%//' || echo "0")
    if (( $(echo "$COVERAGE >= 80" | bc -l 2>/dev/null || echo "0") )); then
        echo "  âœ“ Coverage check passed ($COVERAGE% â‰¥ 80%)"
    else
        echo "  âš ï¸  Coverage $COVERAGE% below 80% threshold"
        echo "  ğŸ’¡ This is a warning - add tests to improve coverage"
        # Not blocking for now, but logged as warning
    fi
else
    echo "  âš ï¸  cargo-llvm-cov not found, skipping coverage check"
    echo "  ğŸ’¡ Install: cargo install cargo-llvm-cov"
fi

# Summary
if [ $QUALITY_VIOLATIONS -gt 0 ]; then
    echo ""
    echo "âŒ Pre-commit quality gates FAILED!"
    echo "   Found $QUALITY_VIOLATIONS quality violations"
    echo "   ğŸ¯ Toyota Way: Stop the line, fix quality at source"
    echo ""
    echo "ğŸ”§ Quick fixes:"
    echo "   cargo fmt              # Auto-format code"
    echo "   cargo clippy --fix     # Auto-fix simple issues"
    echo "   pmat quality-gate      # Run comprehensive quality analysis"
    exit 1
fi

echo ""
echo "âœ… All pre-commit quality gates passed!"
echo "   ğŸ¯ Toyota Way: Quality built-in, documentation synchronized"
echo "   ğŸ“ Documentation updates verified"
echo "   ğŸ“š Documentation validation passed (pmat validate-docs)"
echo "   ğŸ”§ Code quality standards maintained (â‰¤10 complexity, zero SATD)"
echo "   âœ“ Ready for commit"
