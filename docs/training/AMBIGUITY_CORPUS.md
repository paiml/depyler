# DEPYLER-1318: Ambiguity Corpus Training Guide

## Overview

The **Ambiguity Corpus** is a targeted synthetic dataset designed to train the Depyler Oracle
to recognize and predict dictionary type inference failures. This addresses the "Dict Key Paradox"
where the transpiler's type system has conflicting expectations:

- `type_tokens.rs` expects `HashMap<String, V>`
- `type_mapper.rs` infers `HashMap<DepylerValue, V>`

This conflict causes massive E0308 (Type Mismatch) failures in dictionary-heavy Python code.

## Quick Start

```bash
# 1. Generate 2,000 hostile Python files
python scripts/generate_ambiguity_corpus.py \
    --output training_corpus/ambiguity_v1 \
    --count 2000

# 2. Vectorize failures (extract ML features)
cargo run --bin depyler -- graph vectorize \
    --corpus training_corpus/ambiguity_v1 \
    --output training_corpus/ambiguity_vectors.ndjson

# 3. Train the Oracle
cargo run --release --example train_ambiguity_corpus -p depyler-oracle -- \
    --output ~/.depyler/depyler_oracle_v3.23.apr
```

## Hostile Patterns

The corpus generator creates files targeting four specific failure modes:

### Pattern 1: The Literal Trap (30%)

Tests dict literal type inference edge cases:

```python
# String keys vs int keys
str_dict = {"a": 1, "b": 2}
int_dict = {1: "a", 2: "b"}

# Empty dicts (hardest case)
empty = {}
empty["key"] = 42
empty[0] = "value"  # Key type now ambiguous!

# Mixed keys in comprehension
mixed = {(i if i % 2 == 0 else str(i)): i ** 2 for i in range(10)}
```

### Pattern 2: The Flow Gap (30%)

Tests dict type propagation through functions:

```python
def process(data: Dict[str, int]) -> int:
    return sum(data.values())

raw = {"a": 1, "b": 2}  # Inferred as bare dict
result = process(raw)   # Type mismatch at call site

def mutate(d: dict) -> None:
    d["str_key"] = 100
    d[999] = "int_key"  # Changes key type mid-function!
```

### Pattern 3: The Method Clash (25%)

Tests classes with `to_dict`/`from_dict` methods:

```python
class Entity:
    def to_dict(self) -> dict:
        return {
            "name": self.name,     # str value
            "count": self.count,   # int value
            42: "secret",          # int KEY - breaks assumption
        }

    @classmethod
    def from_dict(cls, data: dict) -> "Entity":
        return cls(data["name"], data["count"])
```

### Pattern 4: The Module Boundary (15%)

Tests cross-module dict type inference:

```python
# module_a.py
GLOBAL_DICT = {"a": 1}
GLOBAL_INT_DICT = {1: "a"}

# module_b.py
from module_a import GLOBAL_DICT, GLOBAL_INT_DICT

def use_imported():
    GLOBAL_DICT["b"] = 2       # Expects str key
    GLOBAL_INT_DICT[2] = "b"   # Expects int key
    merged = {**GLOBAL_DICT, **GLOBAL_INT_DICT}  # Mixed keys!
```

## Generator Script

The corpus is generated by `scripts/generate_ambiguity_corpus.py`:

```bash
# Default: 2000 files
python scripts/generate_ambiguity_corpus.py

# Custom count and output
python scripts/generate_ambiguity_corpus.py \
    --output training_corpus/custom_v1 \
    --count 5000
```

### Output Structure

```
training_corpus/ambiguity_v1/
├── MANIFEST.txt                    # Corpus metadata
├── literal_trap_0000.py           # Pattern 1 files (600)
├── literal_trap_0001.py
├── ...
├── flow_gap_0600.py               # Pattern 2 files (600)
├── ...
├── method_clash_1200.py           # Pattern 3 files (500)
├── ...
├── module_boundary_module_*.py    # Pattern 4 files (300)
└── composite_*.py                 # Multi-pattern files
```

## Vectorization

The `depyler graph vectorize` command transpiles each Python file and extracts
failure vectors containing:

- Error code (E0308, E0599, E0609, etc.)
- Error message
- AST context (function, class, statement type)
- Graph context (call graph position, inheritance)
- Source snippet
- Classification labels

```bash
cargo run --bin depyler -- graph vectorize \
    --corpus training_corpus/ambiguity_v1 \
    --output training_corpus/ambiguity_vectors.ndjson \
    --format ndjson
```

### Expected Output

From 2,000 hostile files, expect:
- **14,000+ failure vectors** (7+ failures per file average)
- **3,500+ E0308 errors** (Type Mismatch)
- Multiple error types: E0599, E0609, E0119

## Oracle Training

### Using the Example

```bash
cargo run --release --example train_ambiguity_corpus -p depyler-oracle -- \
    --vectors training_corpus/ambiguity_vectors.ndjson \
    --output ~/.depyler/depyler_oracle_v3.23.apr \
    --balance \
    --max-per-class 2500
```

### Using the Unified Training Pipeline

```bash
cargo run --release --example train_unified_corpus -p depyler-oracle -- \
    --graph training_corpus/ambiguity_vectors.ndjson \
    --output ~/.depyler/depyler_oracle_v3.23.apr \
    --balance
```

### Training Parameters

| Parameter | Default | Description |
|-----------|---------|-------------|
| `--vectors` | `training_corpus/ambiguity_vectors.ndjson` | Input failure vectors |
| `--output` | `depyler_oracle_ambiguity.apr` | Output model path |
| `--seed` | 1318 | Random seed for reproducibility |
| `--synthetic-samples` | 6000 | Background synthetic samples |
| `--balance` | true | Balance class distribution |
| `--max-per-class` | 2500 | Max samples per error category |

## Success Criteria

The trained model should achieve:

1. **TypeMismatch samples**: ≥1,500 in training set
2. **Prediction confidence**: >95% on Dict Key type mismatches
3. **Failure coverage**: >14,000 distinct failure vectors
4. **Model accuracy**: >75% overall (estimated from class balance)

## Troubleshooting

### "Vectors file not found"

Generate the corpus first:
```bash
python scripts/generate_ambiguity_corpus.py
cargo run --bin depyler -- graph vectorize ...
```

### Low TypeMismatch count

The patterns may be too easy. Increase hostility by:
1. Adding more edge cases to the generator
2. Increasing corpus size with `--count 5000`
3. Focusing on empty dict patterns (hardest case)

### Training accuracy below 75%

- Enable class balancing: `--balance`
- Reduce max per class: `--max-per-class 1500`
- Add more synthetic background samples: `--synthetic-samples 12000`

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Python Hostile Code                       │
│  (Literal Trap, Flow Gap, Method Clash, Module Boundary)    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Depyler Transpiler                      │
│  type_mapper.rs ←──conflict──→ type_tokens.rs               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ E0308, E0599, E0609
┌─────────────────────────────────────────────────────────────┐
│                    Failure Vectorization                     │
│  graph vectorize → NDJSON feature vectors                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Oracle Training                         │
│  aprender ML → depyler_oracle_v3.23.apr                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Improved Type Inference                    │
│  Predict TypeMismatch: Dict Key with >95% confidence        │
└─────────────────────────────────────────────────────────────┘
```

## Related Issues

- **DEPYLER-1318**: Type System Schism (Dict Key Paradox)
- **DEPYLER-1203**: NASA Mode Dictionary Handling
- **DEPYLER-1314**: UnificationVar handling in type_tokens.rs
- **DEPYLER-0304**: HashMap Type Inference (Phase 1)
- **DEPYLER-0330**: dict.get() Option Handling

## Files

| File | Description |
|------|-------------|
| `scripts/generate_ambiguity_corpus.py` | Hostile Python code generator |
| `training_corpus/ambiguity_v1/` | Generated Python files |
| `training_corpus/ambiguity_vectors.ndjson` | Vectorized failures |
| `~/.depyler/depyler_oracle_v3.23.apr` | Trained model |
| `crates/depyler-oracle/examples/train_ambiguity_corpus.rs` | Training example |
