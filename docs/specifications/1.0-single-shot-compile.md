# 1.0 Single-Shot Compile Specification: The Unified Standard

**Version**: 2.2.0 (Streamlined with Archives)
**Date**: 2026-01-25
**Status**: **ACTIVE IMPLEMENTATION**
**Authors**: Depyler Team

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Active Phase: 6d](#2-active-phase-6d)
3. [Architecture Overview](#3-architecture-overview)
4. [Structural Typing Solutions](#4-structural-typing-solutions)
5. [Performance Infrastructure](#5-performance-infrastructure)
6. [Sovereign Type Database](#6-sovereign-type-database)
7. [Falsification Framework](#7-falsification-framework)
8. [Epistemic Health Metrics (DEPYLER-1322)](#8-epistemic-health-metrics-depyler-1322)
9. [ML Infrastructure Activation (DEPYLER-1328)](#9-ml-infrastructure-activation-depyler-1328)
- [Appendix D: Phase 6 Empirical Findings](#appendix-d-phase-6-empirical-findings)
- [Appendix E: Claude Sub-Agent Architecture](#appendix-e-claude-sub-agent-architecture)

**Archives** (historical details moved to reduce spec size):
- [`1.0-single-shot-compile-archive/completed-tickets.md`](./1.0-single-shot-compile-archive/completed-tickets.md) â€” 146+ resolved DEPYLER tickets
- [`1.0-single-shot-compile-archive/root-cause-analyses.md`](./1.0-single-shot-compile-archive/root-cause-analyses.md) â€” Five-Whys investigations
- [`1.0-single-shot-compile-archive/falsifier-checklist.md`](./1.0-single-shot-compile-archive/falsifier-checklist.md) â€” 100-point Popper strategy

---

## 1. Executive Summary

### Vision
Enable Python developers to compile **ANY** Python script to a highly optimized, type-safe Rust binary with a single command.

```bash
depyler compile my_script.py --release
# Result: ./my_script (native binary, 10-50x faster)
```

### Current Status (Jan 25, 2026)

| Metric | Value |
|--------|-------|
| **Compile Rate** | **16.25%** (13/80 examples corpus) |
| **Target** | 80% |
| **Total Errors** | 2,804 across corpus |
| **Test Suite** | 11,309 passing (GREEN BOARD) |

**Recent Achievements**:
- **GH-204**: IN PROGRESS â€” E0425 Vocabulary Expansion (+14 builtins: callable, id, ascii, vars, dir, globals, locals, delattr, staticmethod, classmethod, property, breakpoint, exit, quit)
- **DEPYLER-1321**: COMPLETE â€” Escape Rate Metric (Popper's recommendation)
- **DEPYLER-1320**: COMPLETE â€” Dict Unification (+10.3pp on test corpus)

**Current Blockers** (from ROI metrics):
| Error | Count | Description |
|-------|-------|-------------|
| **E0425** | 1,487 | Missing Import - unresolved identifiers |
| **E0423** | 504 | Expected value, found struct/enum |
| **E0599** | 197 | Missing methods on generated types |
| **E0308** | 95 | Type mismatch - coercion gaps |
| **E0282** | 60 | Missing explicit type annotations |

---

## 2. Active Phase: 6d

### THE FINAL PUSH
**Objective**: Address top blockers and cross the 40% threshold.

| Task | Status | Target |
|------|--------|--------|
| **E0425 Missing Imports** | ğŸ“‹ Planned | Resolve identifier resolution |
| **Pattern Autopsy** | ğŸ“‹ Planned | Oracle analysis of remaining E0308 |
| **Method Stubs** | ğŸ“‹ Planned | Generate missing impls for E0599 |

**Exit Criteria**:
- [ ] E0425 errors < 500
- [ ] Compile rate â‰¥ 40%

---

## 3. Architecture Overview

Depyler uses a **Multi-Pass Compiler** architecture with an Oracle feedback loop:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Python    â”‚â”€â”€â”€â–¶â”‚  Transpiler â”‚â”€â”€â”€â–¶â”‚    Rust     â”‚
â”‚   Source    â”‚    â”‚  (depyler)  â”‚    â”‚   Source    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â–¼
                   â”‚   Oracle    â”‚â—€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  (ML Model) â”‚     â”‚    rustc    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚   check     â”‚
                          â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Constraint â”‚
                   â”‚  Injection  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Components**:
- **Type Mapper**: Python â†’ Rust type inference
- **PyOps Traits**: `PyAdd`, `PySub`, `PyIndex`, `PyTruthy` for semantic parity
- **DepylerValue**: Universal fallback for dynamic types
- **Oracle**: ML model predicting error categories and fixes
- **CITL Flight Recorder**: Decision tracing for debugging
- **Escape Rate Tracker**: Monitors DepylerValue usage (DEPYLER-1321)

For detailed root cause analyses of past fixes, see [root-cause-analyses.md](./1.0-single-shot-compile-archive/root-cause-analyses.md).

---

## 4. Structural Typing Solutions

### 4.1 Automated Oracle Loop (Multi-Pass Architecture)

**Workflow**:
1. **Pass 1 (Heuristic)**: Transpile Python â†’ Rust using best-guess heuristics
2. **Oracle (Verification)**: Run `cargo check` to generate JSON diagnostics
3. **Learning (Constraint Extraction)**: Extract "expected T, found U" constraints
4. **Feedback (Refinement)**: Inject constraints into symbol table
5. **Pass 2 (Corrected)**: Re-transpile with guaranteed-correct type hints

### 4.2 PyOps Trait Dispatch

Instead of manual casting, we use Rust's trait system:
- **Traits**: `PyAdd<Rhs>`, `PyGetItem`, `PyTruthy`
- **Impls**: For `i32`, `f64`, `String`, `Vec<T>`, `DepylerValue`
- **Codegen**: Generate `x.py_add(y)` instead of `(x as f64) + y`

### 4.3 Sovereign Type DB

A compact binary artifact containing function signatures of popular Python libraries. See [Section 6](#6-sovereign-type-database) for details.

---

## 5. Performance Infrastructure

### RAM Disk Strategy

All build artifacts redirected to RAM disk for 60-80% speedup:

```bash
export TMPDIR=/Volumes/DepylerRAM/tmp
export CARGO_TARGET_DIR=/Volumes/DepylerRAM/cargo_target
```

**Recommended Size**: 64GB - 256GB

---

## 6. Sovereign Type Database

### Purpose
Eliminate type guesswork by providing ground truth for external library types.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Harvesterâ”‚â”€â”€â”€â–¶â”‚ Extractor â”‚â”€â”€â”€â–¶â”‚ Parquet DB   â”‚
â”‚   (uv)   â”‚    â”‚(rustpythonâ”‚    â”‚ (arrow v54)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  parser)  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                        â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ depyler-core â”‚
                                â”‚ type_mapper  â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Usage

```bash
cargo run -p depyler-knowledge --bin build-type-db -- \
    --packages "requests,numpy,pandas" \
    --output crates/depyler-core/src/data/stdlib_types.parquet
```

---

## 7. Falsification Framework

### The Popperian Mandate

Per Karl Popper's falsificationism, each DEPYLER feature includes explicit falsification criteria.

### Strategic Falsifier

| ID | Criterion | Threshold |
|----|-----------|-----------|
| **S1** | E0308 Error Reduction after integration | **â‰¥10% reduction** |

If E0308 errors do not decrease by at least 10% after a major feature, the strategy is **FALSIFIED**.

### Validation Protocol

```bash
cargo test -p depyler-knowledge --test falsification
# Expected: NOT FALSIFIED (Implementation Valid)
```

For the complete 100-point falsifier checklist, see [falsifier-checklist.md](./1.0-single-shot-compile-archive/falsifier-checklist.md).

---

## 8. Epistemic Health Metrics (DEPYLER-1322)

### 8.1 The Popperian Critique

*"A theory that explains everything explains nothing."* â€” Karl Popper

Analysis reveals **paradigm exhaustion** at the 40% plateau:

| Phase | Strategy | Î” Compile Rate |
|-------|----------|----------------|
| 1-3 | Pattern matching | 0% â†’ 25% (+25 pp) |
| 4 | PyOps traits | 25% â†’ 33% (+8 pp) |
| 5 | Oracle loop | 33% â†’ 40% (+7 pp) |
| 6 | Dict Unification | Improvement varies by corpus |

**Diagnosis**: Protective belts (DepylerValue, Oracle Loop, NASA Mode) may be hiding failures rather than solving them.

### 8.2 DepylerValue Escape Rate (DEPYLER-1321 - COMPLETE)

**Definition**: Percentage of generated type annotations using `DepylerValue` as fallback.

```
Escape Rate = (DepylerValue annotations) / (Total type annotations) Ã— 100
```

**Implementation**: Added `EscapeRateTracker` with atomic counters for thread-safe tracking.

**Warning Thresholds**:
| Escape Rate | Status |
|-------------|--------|
| 0-10% | ğŸŸ¢ GREEN |
| 10-20% | ğŸŸ¡ YELLOW |
| >20% | ğŸ”´ RED (inference failing) |

### 8.3 Two-Tier Architecture Proposal

| Tier | Input | Output | Strategy |
|------|-------|--------|----------|
| **Tier 1** | Fully typed Python | Native Rust types | Direct mapping |
| **Tier 2** | Untyped Python | `DepylerValue` throughout | Universal embedding |

### 8.4 Differential Testing

**Protocol**:
```bash
# For each transpiled file:
1. Generate random inputs (1000 iterations)
2. Run Python: python script.py < inputs > python_output
3. Run Rust:   ./script < inputs > rust_output
4. Compare:    diff python_output rust_output
```

**Metric**: `Semantic Parity = (Files with matching output) / (Files that compile) Ã— 100`

### 8.5 Implementation Roadmap

| Phase | Task | Status | Ticket |
|-------|------|--------|--------|
| 8a | Escape Rate Tracking | âœ… COMPLETE | DEPYLER-1321 |
| 8b | Dashboard Integration | ğŸ“‹ Planned | DEPYLER-1323 |
| 8c | Differential Testing | ğŸ“‹ Planned | DEPYLER-1324 |
| 8d | Graveyard Creation | ğŸ“‹ Planned | DEPYLER-1325 |
| 8e | Untranspilable Grammar | ğŸ“‹ Planned | DEPYLER-1326 |
| 8f | Tier Classification | ğŸ“‹ Planned | DEPYLER-1327 |

---

## 9. ML Infrastructure Activation (DEPYLER-1328)

The `entrenar` and `aprender` crates contain substantial underutilized ML infrastructure.

### 9.1 Tier 1: Immediate Activation (Score â‰¥ 8.0)

| Feature | Score | Location | Ticket |
|---------|-------|----------|--------|
| **CITL Pattern Store** | 9.2 | `entrenar::citl_trainer` | DEPYLER-1329 |
| **Active Learning Gate** | 8.8 | `aprender::sampling` | DEPYLER-1330 |
| **Tarantula Fault Localization** | 8.5 | `entrenar::tarantula` | DEPYLER-1331 |
| **Isolation Forest** | 8.1 | `aprender::isolation_forest` | DEPYLER-1332 |

### 9.2 Tier 2: Near-Term (Score 6.0-8.0)

| Feature | Score | Ticket |
|---------|-------|--------|
| Online Learning | 7.6 | DEPYLER-1333 |
| ADWIN Drift Detection | 7.4 | DEPYLER-1334 |
| Mixture of Experts | 7.2 | DEPYLER-1335 |
| **Claude Sub-Agent** | 7.0 | DEPYLER-1336 |
| Feature Importance | 6.8 | DEPYLER-1337 |
| FailureContext Enrichment | 6.5 | DEPYLER-1338 |

### 9.3 Tier 3: Research (Score 4.0-6.0)

| Feature | Score | Ticket |
|---------|-------|--------|
| Knowledge Distillation | 5.8 | DEPYLER-1339 |
| Curriculum Learning | 5.5 | DEPYLER-1340 |
| GNN for AST | 5.2 | DEPYLER-1341 |
| Contrastive Learning | 4.8 | DEPYLER-1342 |

### 9.4 Implementation Roadmap

```
Q1 2026 (Immediate)
â”œâ”€â”€ DEPYLER-1329: CITL Pattern Store wiring
â”œâ”€â”€ DEPYLER-1330: Active Learning Gate
â”œâ”€â”€ DEPYLER-1331: Tarantula integration
â””â”€â”€ DEPYLER-1332: Isolation Forest anomaly detection

Q2 2026 (Near-Term)
â”œâ”€â”€ DEPYLER-1333-1338: Tier 2 features
â””â”€â”€ DEPYLER-1336: Claude Sub-Agent MVP

Q3 2026 (Research)
â””â”€â”€ DEPYLER-1339-1342: Tier 3 experiments
```

---

## Appendix D: Phase 6 Empirical Findings

### Phase 6c: The Unification Treaty (DEPYLER-1320)

**Problem**: Civil war between two codegen paths for dict access.

**Root Causes Fixed**:
1. `direct_rules_convert.rs::convert_index` - Added `.into()` for NASA mode
2. `stmt_gen.rs` - Skip redundant JSON-to-String conversion
3. `type_tokens.rs` - Updated Unknown type mapping

**Empirical Result**: +10.3pp improvement on test corpus (29.0% â†’ 39.3%)

### Phase 6d: Current Status (DEPYLER-1321)

**Dashboard Output** (Oracle v3.22.0):
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           PHASE 6d DASHBOARD                                 â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Passing:           13/80 (16.25%) - examples corpus          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ TOP CLUSTER: E0425 (1,487 errors)                            â•‘
â•‘ ROOT CAUSE:  Missing Import / Unresolved Identifiers         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ NEW METRIC:  Escape Rate Tracking ACTIVE                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Appendix E: Claude Sub-Agent Architecture

### System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Oracle Pipeline                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Error      â”‚â”€â”€â”€â–¶â”‚   Oracle     â”‚â”€â”€â”€â–¶â”‚   Confidence     â”‚  â”‚
â”‚  â”‚   Input      â”‚    â”‚   Predict    â”‚    â”‚   Check          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                    â”‚             â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                           â–¼                                â–¼    â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                  â”‚ Confidence â‰¥ T â”‚              â”‚Confidence <Tâ”‚â”‚
â”‚                  â”‚ (Use Oracle)   â”‚              â”‚(Escalate)   â”‚â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                         â”‚       â”‚
â”‚                                                         â–¼       â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                                              â”‚  Claude API      â”‚â”‚
â”‚                                              â”‚  Sub-Agent       â”‚â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Query Protocol

```rust
pub struct ClaudeQuery {
    pub error: CompilerError,
    pub python_source: String,
    pub rust_source: String,
    pub oracle_prediction: Option<ErrorCategory>,
    pub oracle_confidence: f64,
}

pub struct ClaudeResponse {
    pub category: ErrorCategory,
    pub explanation: String,
    pub fix_suggestion: Option<String>,
    pub confidence: f64,
    pub reasoning: Vec<String>,
}
```

### Cost-Benefit Analysis

| Factor | Value |
|--------|-------|
| API Cost | ~$0.015 per escalation (Claude Haiku) |
| Expected Escalation Rate | 5-10% of predictions |
| Fix Accuracy Improvement | Est. +20% on escalated cases |
| Latency | +500-2000ms per escalation |

### Safeguards

1. **Rate Limiting**: Max 100 queries/hour
2. **Caching**: Hash(error + source) â†’ response cache (24h TTL)
3. **Fallback**: If API unavailable, return Oracle prediction
4. **Audit Log**: All queries logged for training data
5. **Cost Cap**: Monthly budget limit with automatic disable

---

**End of Specification**
