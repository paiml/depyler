# 12.8 PMAT TDG Compliance Protocol (DEPYLER-COMPLY-001)

[← Back to TOC](../pareto-complete-single-shot.md)

---

## Objective

Maintain **zero technical debt violations** throughout all refactoring work:
- All files in `crates/` must have TDG score ≤2.0
- Zero critical files (TDG >2.5)
- `pmat comply check` must pass before ANY commit

**Compliance = TDG ≤2.0 + Zero SATD + Complexity ≤10**

---

## Acceptance Criteria

| ID | Criterion | Threshold | Validation |
|----|-----------|-----------|------------|
| **COMPLY-1** | pmat comply check | PASS | `pmat comply check` |
| **COMPLY-2** | TDG score | ≤2.0 | `pmat tdg crates/` |
| **COMPLY-3** | Critical files | 0 | `pmat tdg --critical` |
| **COMPLY-4** | Cyclomatic complexity | ≤10 | `pmat analyze complexity` |
| **COMPLY-5** | Cognitive complexity | ≤10 | `pmat analyze complexity` |
| **COMPLY-6** | SATD comments | 0 | `pmat analyze satd` |
| **COMPLY-7** | Dead code | 0 | `pmat analyze dead-code` |

---

## Why PMAT Compliance is MANDATORY

**Technical Debt Accumulation is the #1 Cause of Project Failure**

Without strict TDG enforcement:
1. Complexity creeps in during "quick fixes"
2. SATD comments become permanent fixtures
3. Code becomes unmaintainable
4. New features break existing functionality
5. Refactoring becomes impossible

**PMAT TDG quantifies technical debt scientifically**, not subjectively.

---

## TDG Grading Scale

| Grade | TDG Score | Meaning |
|-------|-----------|---------|
| **A+** | 0.0-0.5 | Excellent - exemplary code |
| **A** | 0.5-1.0 | Great - minor improvements possible |
| **A-** | 1.0-1.5 | Good - some cleanup needed |
| **B+** | 1.5-2.0 | Acceptable - **THRESHOLD** |
| **B** | 2.0-2.5 | Warning - needs attention |
| **C** | 2.5-3.5 | **CRITICAL** - immediate action |
| **D/F** | 3.5+ | **BLOCKED** - cannot merge |

---

## Refactoring Protocol

### Before ANY Refactoring

```bash
# 1. Baseline current state
pmat tdg crates/ --format json > baseline.json

# 2. Check compliance status
pmat comply check

# 3. Identify problem areas
pmat tdg crates/ --explain --threshold 10
```

### During Refactoring

```bash
# After each file modification
pmat tdg <modified_file.rs> --explain

# Verify no regression
pmat tdg check-regression --baseline baseline.json

# Quality gate check
pmat tdg check-quality --min-grade A-
```

### Before Commit

```bash
# MANDATORY - ALL must pass
pmat comply check                    # Full compliance
pmat analyze satd --fail-on-violation  # Zero SATD
pmat analyze complexity --max-cyclomatic 10  # Complexity
cargo clippy -- -D warnings          # Clippy clean
```

---

## Complexity Reduction Strategies

### When Cyclomatic Complexity > 10

1. **Extract Functions**: Split complex logic into smaller functions
2. **Early Returns**: Replace nested ifs with guard clauses
3. **Strategy Pattern**: Replace switch/match with polymorphism
4. **Table-Driven**: Replace conditionals with lookup tables

### When Cognitive Complexity > 10

1. **Reduce Nesting**: Flatten deeply nested structures
2. **Simplify Conditions**: Break complex boolean expressions
3. **Name Abstractions**: Extract named functions for complex logic
4. **Remove Recursion**: Convert to iterative where possible

---

## SATD Elimination

### Forbidden Comments

```rust
// These are NEVER allowed:
// TODO: ...
// FIXME: ...
// HACK: ...
// XXX: ...
// TEMP: ...
// KLUDGE: ...
```

### What to Do Instead

1. **Create a ticket**: Document in DEPYLER-XXXX issue
2. **Fix immediately**: If < 30 min, fix now
3. **Document in spec**: If architectural, add to spec
4. **Remove the comment**: No SATD in codebase

---

## Integration with CI/CD

### Pre-commit Hook

```bash
#!/bin/bash
# .git/hooks/pre-commit
pmat comply check || exit 1
```

### CI Pipeline

```yaml
- name: PMAT Compliance Gate
  run: |
    pmat comply check
    pmat tdg check-quality --min-grade A-
    pmat analyze satd --fail-on-violation
```

---

## Exception Process

**There are NO exceptions to PMAT compliance.**

If you believe a file legitimately cannot meet TDG ≤2.0:

1. Document the technical reason
2. Create DEPYLER-XXXX ticket
3. Get explicit approval in PR review
4. Add to `.pmat/exceptions.toml` with justification
5. Set expiration date for exception

```toml
# .pmat/exceptions.toml
[[exception]]
file = "crates/depyler-core/src/legacy_parser.rs"
max_tdg = 2.5
reason = "Legacy parser pending rewrite in DEPYLER-1234"
expires = "2026-01-15"
```

---

## Commands Quick Reference

```bash
# Full compliance check
pmat comply check

# TDG analysis
pmat tdg crates/                     # All crates
pmat tdg <file.rs> --explain         # Single file with explanation
pmat tdg --critical                  # Show only critical files

# Quality gates
pmat tdg check-quality --min-grade A-
pmat tdg check-regression --baseline baseline.json

# Specific checks
pmat analyze complexity --max-cyclomatic 10 --fail-on-violation
pmat analyze satd --fail-on-violation
pmat analyze dead-code
pmat analyze duplicates --threshold 0.8
```

---

## Related Documents

- [12.6-coverage.md](12.6-coverage.md) - Coverage requirements
- [CLAUDE.md](../../../CLAUDE.md) - Development protocols
