# v3.18.0 Release Plan - Transpiler Modularization

**Release Version**: v3.18.0
**Release Type**: Major Code Refactoring
**Status**: 📋 Planning Phase
**Created**: 2025-10-10
**Target Completion**: TBD
**Estimated Effort**: 13-19 hours (execution) + 2-3 hours (planning/docs)

---

## Executive Summary

**Goal**: Execute the comprehensive rust_gen.rs modularization plan created in v3.17.0 Phase 4, transforming a 4,927-line monolithic file into 10 focused, maintainable modules while preserving all functionality and test coverage.

**Strategic Value**:
- **Maintainability**: Easier to understand, modify, and extend transpiler logic
- **Quality**: All modules will meet A+ code standards (≤10 complexity)
- **Velocity**: Future feature development will be faster with clear module boundaries
- **Foundation**: Sets stage for advanced optimizations (parallel codegen, pluggable backends)

**Risk Level**: 🟡 MEDIUM-HIGH (core transpilation logic, 735 tests must pass)

---

## Context & Prerequisites

### What Was Done in v3.17.0

**Phase 4 - Transpiler Modularization Planning** ✅ Complete
- Comprehensive analysis of rust_gen.rs (4,927 LOC)
- Defined 10-module architecture with clear responsibilities
- Created detailed 8-phase migration strategy
- Identified risk levels for each extraction phase
- Documented rollback procedures and success metrics
- **Deliverable**: `docs/design/rust_gen_modularization_plan.md` (500 lines)

### What Will Be Done in v3.18.0

**Execution of the 8-Phase Migration Plan**:
- Phase 2: Extract pure functions (format, error_gen, type_gen) - 2-3 hours
- Phase 3: Extract context & imports - 1-2 hours
- Phase 4: Extract generator support - 2 hours
- Phase 5: Extract expression codegen - 3-4 hours 🔴 HIGH RISK
- Phase 6: Extract statement codegen - 2-3 hours
- Phase 7: Extract function codegen - 2-3 hours
- Phase 8: Create mod.rs & final integration - 1-2 hours

### Success Criteria (NON-NEGOTIABLE)

**Functional Correctness**:
- ✅ ALL 735+ tests pass (zero regressions)
- ✅ All showcase examples compile and run
- ✅ Zero clippy warnings with `-D warnings`

**Code Quality**:
- ✅ All modules achieve PMAT grade A- or higher
- ✅ All functions have cyclomatic complexity ≤10
- ✅ Zero SATD comments in production code

**Performance**:
- ✅ Transpilation time within 5% of baseline
- ✅ Memory usage within 10% of baseline

---

## Phase-by-Phase Implementation Plan

### Phase 1: Planning & Setup ✅ COMPLETE

**What**: Create comprehensive modularization plan
**Status**: ✅ Complete (v3.17.0 Phase 4)
**Deliverable**: `docs/design/rust_gen_modularization_plan.md`

---

### Phase 2: Extract Pure Functions (2-3 hours)

**Ticket**: DEPYLER-TBD
**Risk**: 🟢 LOW
**Focus**: Standalone utilities with minimal dependencies

#### 2.1: Create Module Directory Structure

```bash
mkdir -p crates/depyler-core/src/rust_gen
```

#### 2.2: Extract format.rs (~30 min)

**What to Move**:
- `format_rust_code()` function (lines 4136-4190)

**File**: `crates/depyler-core/src/rust_gen/format.rs`

**Testing**:
```bash
cargo test --lib -p depyler-core
cargo clippy --all-targets -- -D warnings
```

**Success**: All tests pass, zero warnings

#### 2.3: Extract error_gen.rs (~30 min)

**What to Move**:
- `generate_error_type_definitions()` (lines 302-357)

**File**: `crates/depyler-core/src/rust_gen/error_gen.rs`

**Testing**: Same as 2.2

#### 2.4: Extract type_gen.rs (~1-2 hours)

**What to Move** (in this order):
1. `rust_type_to_syn()` - Main type conversion
2. `str_type_to_syn()` - String lifetime handling
3. `reference_type_to_syn()` - Reference types
4. `array_type_to_syn()` - Fixed-size arrays
5. `convert_binop()` - Binary operators
6. `update_import_needs()` - Import tracking

**File**: `crates/depyler-core/src/rust_gen/type_gen.rs`

**Testing**: Run after EACH function extraction
```bash
cargo test --lib -p depyler-core
```

**Complexity Check**:
```bash
pmat analyze complexity crates/depyler-core/src/rust_gen/type_gen.rs --max-cyclomatic 10
```

#### Phase 2 Validation

**Comprehensive Test Run**:
```bash
cargo test --lib -p depyler-core
cargo clippy --all-targets -- -D warnings
pmat tdg crates/depyler-core/src/rust_gen --min-grade B+
```

**Deliverables**:
- [ ] `src/rust_gen/format.rs` created
- [ ] `src/rust_gen/error_gen.rs` created
- [ ] `src/rust_gen/type_gen.rs` created
- [ ] All 735+ tests passing
- [ ] Zero clippy warnings

**Git Strategy**:
```bash
git checkout -b v3.18.0-phase2-pure-functions
git commit -m "[DEPYLER-TBD] Phase 2.1: Extract format.rs"
git commit -m "[DEPYLER-TBD] Phase 2.2: Extract error_gen.rs"
git commit -m "[DEPYLER-TBD] Phase 2.3: Extract type_gen.rs"
```

---

### Phase 3: Extract Context & Imports (1-2 hours)

**Ticket**: DEPYLER-TBD
**Risk**: 🟢 LOW
**Focus**: Well-isolated infrastructure

#### 3.1: Extract context.rs (~30-45 min)

**What to Move**:
- `CodeGenContext` struct (lines 1-73)
- `RustCodeGen` trait definition
- Scope management methods: `enter_scope()`, `exit_scope()`, `is_declared()`, `declare_var()`
- `ToRustExpr` trait definition (to avoid circular dependencies)

**File**: `crates/depyler-core/src/rust_gen/context.rs`

**Key Decision**: Place `ToRustExpr` trait here to avoid circular dependencies between `expr_gen.rs` and `stmt_gen.rs`

**Testing**:
```bash
cargo test --lib -p depyler-core
```

#### 3.2: Extract import_gen.rs (~30-45 min)

**What to Move** (lines 75-410):
- `process_module_imports()` - Main entry point
- `process_whole_module_import()`
- `process_specific_items_import()`
- `process_import_item()`
- `generate_import_tokens()` - Generate use statements
- `generate_conditional_imports()` - HashMap, HashSet, etc.

**File**: `crates/depyler-core/src/rust_gen/import_gen.rs`

**Testing**: Same as 3.1

#### Phase 3 Validation

```bash
cargo test --lib -p depyler-core
cargo clippy --all-targets -- -D warnings
pmat tdg crates/depyler-core/src/rust_gen --min-grade B+
```

**Deliverables**:
- [ ] `src/rust_gen/context.rs` created
- [ ] `src/rust_gen/import_gen.rs` created
- [ ] All tests passing
- [ ] Zero clippy warnings

**Git Strategy**:
```bash
git checkout -b v3.18.0-phase3-context-imports
git commit -m "[DEPYLER-TBD] Phase 3.1: Extract context.rs with ToRustExpr trait"
git commit -m "[DEPYLER-TBD] Phase 3.2: Extract import_gen.rs"
```

---

### Phase 4: Extract Generator Support (2 hours)

**Ticket**: DEPYLER-TBD
**Risk**: 🟡 MEDIUM
**Focus**: Isolated generator-specific logic

#### 4.1: Extract generator_gen.rs (~2 hours)

**What to Move** (lines 517-1152):
- `codegen_generator_function()` - Main generator codegen
- `generate_state_fields()` - State variable fields
- `generate_param_fields()` - Captured parameter fields
- `extract_generator_item_type()` - Iterator::Item type
- `generate_state_initializers()` - Default values
- `generate_param_initializers()` - Param capture
- `get_default_value_for_type()` - Type defaults

**File**: `crates/depyler-core/src/rust_gen/generator_gen.rs`

**Testing** (Generator-specific):
```bash
cargo test -p depyler-core --lib | grep generator
cargo test lambda_integration_test  # Uses generators
cargo test generator  # All generator tests
```

**Success Criteria**:
- ✅ All 20/20 generator expression tests pass
- ✅ Lambda integration test passes
- ✅ No regressions in other tests

#### Phase 4 Validation

```bash
cargo test --workspace
pmat analyze complexity crates/depyler-core/src/rust_gen/generator_gen.rs --max-cyclomatic 10
```

**Deliverables**:
- [ ] `src/rust_gen/generator_gen.rs` created
- [ ] All generator tests passing (20/20)
- [ ] Zero complexity violations

**Git Strategy**:
```bash
git checkout -b v3.18.0-phase4-generator-support
git commit -m "[DEPYLER-TBD] Phase 4: Extract generator_gen.rs"
```

---

### Phase 5: Extract Expression Codegen (3-4 hours) 🔴 HIGH RISK

**Ticket**: DEPYLER-TBD
**Risk**: 🔴 HIGH (largest module, ~1800 LOC)
**Focus**: Careful, incremental extraction with testing at each step

#### ⚠️ CRITICAL: Safety Protocol

**BEFORE STARTING**:
```bash
# Create backup
cp crates/depyler-core/src/rust_gen.rs crates/depyler-core/src/rust_gen.rs.backup

# Measure baseline performance
cargo bench --bench transpile_benchmark | tee baseline_perf.txt

# Create safety branch
git checkout -b v3.18.0-phase5-expression-codegen-SAFETY
git commit -m "[DEPYLER-TBD] Phase 5 checkpoint: BEFORE expression extraction"
```

**ROLLBACK CRITERIA** (STOP if ANY occur):
- >5 test failures at once
- >10% performance regression
- Circular dependency errors

#### 5.1: Create expr_gen.rs Skeleton (~15 min)

**File**: `crates/depyler-core/src/rust_gen/expr_gen.rs`

```rust
use crate::rust_gen::context::{CodeGenContext, ToRustExpr};
use crate::hir::HirExpr;
use proc_macro2::TokenStream;
use anyhow::Result;

// Skeleton - will be filled incrementally
```

#### 5.2: Move Helper Functions (Leaf-first) (~1 hour)

**Order** (least dependencies → most dependencies):
1. `literal_to_rust_expr()` - No dependencies
2. `classify_string_method()` - Enum definition
3. `contains_owned_string_method()` - Recursive helper
4. `return_type_expects_float()` - Type checking
5. `binary_expr_to_rust_expr()` - Uses convert_binop
6. `call_expr_to_rust_expr()` - Function calls
7. `method_call_to_rust_expr()` - Method calls
8. `list_comp_to_rust_expr()` - List comprehensions
9. `generator_exp_to_rust_expr()` - Generator expressions

**Testing**: Run after EACH function move
```bash
cargo test --lib -p depyler-core
# If fails, immediately revert: git revert HEAD
```

#### 5.3: Move Main Implementation (~1.5-2 hours)

**What to Move**:
- `impl ToRustExpr for HirExpr` (~1600 lines, massive match statement)

**Strategy**: Move the entire impl block in ONE commit (don't split match arms)

**Why**: Match arms reference each other; partial moves will break compilation

**Testing**:
```bash
# Run comprehensive expression tests
cargo test --lib -p depyler-core | grep expr
cargo test integration_tests
cargo test operator_tests
```

#### 5.4: Update Dependencies (~15-30 min)

**Files to Update**:
- `src/rust_gen.rs` - Remove extracted code, add `pub use rust_gen::expr_gen::*;`
- Other modules that reference expressions

**Testing**: Full test suite
```bash
cargo test --workspace
```

#### Phase 5 Validation (COMPREHENSIVE)

```bash
# Functional correctness
cargo test --workspace

# Code quality
cargo clippy --all-targets -- -D warnings
pmat tdg crates/depyler-core/src/rust_gen/expr_gen.rs --min-grade B+
pmat analyze complexity crates/depyler-core/src/rust_gen/expr_gen.rs --max-cyclomatic 10

# Performance regression check
cargo bench --bench transpile_benchmark | tee phase5_perf.txt
# Compare to baseline - must be within 5%
```

**Deliverables**:
- [ ] `src/rust_gen/expr_gen.rs` created (~1800 LOC)
- [ ] All expression tests passing
- [ ] All integration tests passing
- [ ] Performance within 5% of baseline
- [ ] Zero complexity violations

**Git Strategy**:
```bash
git commit -m "[DEPYLER-TBD] Phase 5.1: Create expr_gen.rs skeleton"
git commit -m "[DEPYLER-TBD] Phase 5.2: Move expression helper functions (9 functions)"
git commit -m "[DEPYLER-TBD] Phase 5.3: Move impl ToRustExpr for HirExpr"
git commit -m "[DEPYLER-TBD] Phase 5.4: Update dependencies"
```

---

### Phase 6: Extract Statement Codegen (2-3 hours)

**Ticket**: DEPYLER-TBD
**Risk**: 🟡 MEDIUM
**Focus**: Statement generation with expression dependencies

#### 6.1: Create stmt_gen.rs (~15 min)

**File**: `crates/depyler-core/src/rust_gen/stmt_gen.rs`

#### 6.2: Move Statement Helper Functions (~1-1.5 hours)

**What to Move** (in this order):
1. `codegen_pass_stmt()` - Simplest
2. `codegen_break_stmt()`
3. `codegen_continue_stmt()`
4. `codegen_expr_stmt()`
5. `codegen_return_stmt()`
6. `codegen_while_stmt()`
7. `codegen_raise_stmt()`
8. `codegen_with_stmt()`
9. `codegen_if_stmt()` - More complex
10. `codegen_for_stmt()` - Iterator conversion
11. `codegen_assign_stmt()` - Complex assignment strategies
12. `codegen_try_stmt()` - Exception handling

**Testing**: Run after moving every 3 functions
```bash
cargo test --lib -p depyler-core
```

#### 6.3: Move Main Implementation (~30-45 min)

**What to Move**:
- `impl RustCodeGen for HirStmt` (~600 LOC)

**Testing**:
```bash
cargo test --lib -p depyler-core
cargo test integration_tests
cargo test operator_tests
```

#### Phase 6 Validation

```bash
cargo test --workspace
cargo clippy --all-targets -- -D warnings
pmat tdg crates/depyler-core/src/rust_gen/stmt_gen.rs --min-grade B+
pmat analyze complexity crates/depyler-core/src/rust_gen/stmt_gen.rs --max-cyclomatic 10
```

**Deliverables**:
- [ ] `src/rust_gen/stmt_gen.rs` created (~600 LOC)
- [ ] All statement tests passing
- [ ] Control flow tests passing (if/while/for)
- [ ] Assignment tests passing

**Git Strategy**:
```bash
git checkout -b v3.18.0-phase6-statement-codegen
git commit -m "[DEPYLER-TBD] Phase 6.1: Create stmt_gen.rs skeleton"
git commit -m "[DEPYLER-TBD] Phase 6.2: Move statement helper functions (12 functions)"
git commit -m "[DEPYLER-TBD] Phase 6.3: Move impl RustCodeGen for HirStmt"
```

---

### Phase 7: Extract Function Codegen (2-3 hours)

**Ticket**: DEPYLER-TBD
**Risk**: 🟡 MEDIUM
**Focus**: Function-level generation with borrowing logic

#### 7.1: Create function_gen.rs (~15 min)

**File**: `crates/depyler-core/src/rust_gen/function_gen.rs`

#### 7.2: Move Function Helper Functions (~1-1.5 hours)

**What to Move** (lines 610-1257):
1. `codegen_generic_params()` - Generic parameters
2. `codegen_where_clause()` - Where clauses
3. `codegen_function_attrs()` - Attributes
4. `codegen_return_type()` - Return type generation
5. `apply_param_borrowing_strategy()` - Borrowing analysis
6. `apply_borrowing_to_type()` - Type-level borrowing
7. `codegen_single_param()` - Single parameter with borrowing
8. `codegen_function_params()` - Parameter conversion
9. `codegen_function_body()` - Function body with scoping

**Testing**: Run after moving every 3 functions

#### 7.3: Move Main Implementation (~30-45 min)

**What to Move**:
- `impl RustCodeGen for HirFunction`

**Testing**:
```bash
cargo test --lib -p depyler-core
cargo test functional_tests
```

#### Phase 7 Validation

```bash
cargo test --workspace
cargo clippy --all-targets -- -D warnings
pmat tdg crates/depyler-core/src/rust_gen/function_gen.rs --min-grade B+
pmat analyze complexity crates/depyler-core/src/rust_gen/function_gen.rs --max-cyclomatic 10
```

**Deliverables**:
- [ ] `src/rust_gen/function_gen.rs` created (~650 LOC)
- [ ] All function generation tests passing
- [ ] Borrowing and ownership tests passing
- [ ] Generic function tests passing

**Git Strategy**:
```bash
git checkout -b v3.18.0-phase7-function-codegen
git commit -m "[DEPYLER-TBD] Phase 7.1: Create function_gen.rs skeleton"
git commit -m "[DEPYLER-TBD] Phase 7.2: Move function helper functions (9 functions)"
git commit -m "[DEPYLER-TBD] Phase 7.3: Move impl RustCodeGen for HirFunction"
```

---

### Phase 8: Create mod.rs & Final Integration (1-2 hours)

**Ticket**: DEPYLER-TBD
**Risk**: 🟢 LOW
**Focus**: Tie everything together, final validation

#### 8.1: Create mod.rs (~30 min)

**File**: `crates/depyler-core/src/rust_gen/mod.rs`

**Contents**:
```rust
//! Rust code generation from HIR
//!
//! This module is responsible for converting the High-level Intermediate Representation (HIR)
//! into valid Rust code (proc_macro2::TokenStream).
//!
//! ## Module Structure
//!
//! - `context` - Code generation context and traits
//! - `import_gen` - Python import → Rust use statement conversion
//! - `type_gen` - Type conversion utilities
//! - `function_gen` - Function-level code generation
//! - `stmt_gen` - Statement code generation
//! - `expr_gen` - Expression code generation
//! - `generator_gen` - Generator function support
//! - `error_gen` - Error type generation
//! - `format` - Code formatting utilities

// Module declarations
pub mod context;
pub mod import_gen;
pub mod type_gen;
pub mod function_gen;
pub mod stmt_gen;
pub mod expr_gen;
pub mod generator_gen;
pub mod error_gen;
pub mod format;

// Re-exports for backward compatibility
pub use context::{CodeGenContext, RustCodeGen, ToRustExpr};
pub use import_gen::*;
pub use type_gen::*;
pub use function_gen::*;
pub use stmt_gen::*;
pub use expr_gen::*;
pub use generator_gen::*;
pub use error_gen::*;
pub use format::*;

/// Main entry point for generating Rust code from HIR module
pub fn generate_rust_file(module: &HirModule) -> Result<TokenStream> {
    // ... move from old rust_gen.rs lines 425-514
}
```

#### 8.2: Move Main Entry Point (~15 min)

**What to Move**:
- `generate_rust_file()` function (lines 425-514)

#### 8.3: Update Module Imports Throughout Codebase (~15-30 min)

**Files to Update**:
- `crates/depyler-core/src/lib.rs` - Change `mod rust_gen;` to `pub mod rust_gen;`
- Any files that import from `rust_gen` - Update paths
- `crates/depyler-core/src/backend.rs` - Update imports

#### 8.4: Remove Old rust_gen.rs (~5 min)

```bash
git rm crates/depyler-core/src/rust_gen.rs
```

#### Phase 8 Validation (COMPREHENSIVE - FINAL)

**Full Test Suite**:
```bash
cargo test --workspace
```

**Code Quality**:
```bash
cargo clippy --all-targets --all-features -- -D warnings
pmat tdg crates/depyler-core/src/rust_gen --min-grade A-
pmat analyze complexity crates/depyler-core/src/rust_gen --max-cyclomatic 10
pmat analyze satd crates/depyler-core/src/rust_gen --fail-on-violation
```

**Coverage**:
```bash
make coverage
# Should maintain or improve coverage (≥62.93%)
```

**Performance**:
```bash
cargo bench --bench transpile_benchmark | tee final_perf.txt
# Compare to baseline - must be within 5%
```

**Examples**:
```bash
# Verify all showcase examples still compile
cargo run -- transpile examples/showcase/binary_search.py
cargo run -- transpile examples/showcase/annotated_example.py
cargo run -- transpile examples/showcase/marco_polo.py
cargo run -- transpile examples/showcase/safe_division.py
rustc --crate-type lib examples/showcase/*.rs
```

**Deliverables**:
- [ ] `src/rust_gen/mod.rs` created (~200 LOC)
- [ ] `src/rust_gen.rs` removed
- [ ] All module imports updated
- [ ] ALL 735+ tests passing
- [ ] Zero clippy warnings
- [ ] All modules grade A- or higher
- [ ] Coverage maintained or improved
- [ ] Performance within 5% of baseline
- [ ] All showcase examples compile

**Git Strategy**:
```bash
git checkout -b v3.18.0-phase8-final-integration
git commit -m "[DEPYLER-TBD] Phase 8.1: Create mod.rs with re-exports"
git commit -m "[DEPYLER-TBD] Phase 8.2: Move generate_rust_file() to mod.rs"
git commit -m "[DEPYLER-TBD] Phase 8.3: Update module imports throughout codebase"
git commit -m "[DEPYLER-TBD] Phase 8.4: Remove old rust_gen.rs"
```

---

## Risk Management

### Identified Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| Circular dependencies (stmt ↔ expr) | 🔴 HIGH | Place `ToRustExpr` trait in `context.rs` |
| Phase 5 expression extraction breaks tests | 🔴 HIGH | Incremental extraction, test after each function |
| Performance regression | 🟡 MEDIUM | Benchmark baseline, compare after each phase |
| Merge conflicts with parallel work | 🟡 MEDIUM | Feature branch, frequent merges from main |
| Incomplete extraction leaves orphaned code | 🟢 LOW | Use comprehensive checklist, grep for references |

### Rollback Procedures

**Per-Phase Rollback**:
```bash
# If Phase N fails
git revert HEAD~3..HEAD  # Undo all commits in phase
git checkout main
git branch -D v3.18.0-phaseN-*
```

**Full Rollback**:
```bash
# If entire v3.18.0 is unrecoverable
git checkout main
git branch -D v3.18.0-*
# Start over with lessons learned
```

**Success Criteria to MERGE**:
- ✅ All tests pass
- ✅ Zero clippy warnings
- ✅ Coverage ≥ baseline (62.93%)
- ✅ Performance within 5% of baseline
- ✅ All modules grade A- or higher

---

## Testing Strategy

### Unit Tests

Each extracted module gets its own test module:

```rust
// src/rust_gen/type_gen.rs
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_rust_type_to_syn_int() {
        let result = rust_type_to_syn(&RustType::Int);
        // assertions...
    }

    #[test]
    fn test_rust_type_to_syn_option_string() {
        let result = rust_type_to_syn(&RustType::Option(Box::new(RustType::String)));
        // assertions...
    }
}
```

### Integration Tests

**Existing tests must continue to pass**:
```bash
cargo test --workspace
cargo test integration_tests
cargo test functional_tests
cargo test operator_tests
cargo test property_tests
```

### Regression Detection

**After EVERY extraction**:
```bash
cargo test --lib -p depyler-core
```

**After EVERY phase**:
```bash
cargo test --workspace
```

### Performance Testing

**Baseline** (Before Phase 2):
```bash
cargo bench --bench transpile_benchmark | tee baseline_perf.txt
```

**After Phases 2, 3, 4, 5, 6, 7, 8**:
```bash
cargo bench --bench transpile_benchmark | tee phaseN_perf.txt
# Allowed regression: ≤5%
```

---

## Documentation Updates

### Code Documentation

Each new module requires:
- Module-level doc comments explaining responsibility
- Public function doc comments with examples
- Internal comments for complex logic

**Example**:
```rust
//! Expression code generation
//!
//! This module converts HIR expressions into Rust `TokenStream`.
//! It handles all Python expression types including literals, binary operations,
//! function calls, method calls, list comprehensions, and generator expressions.

/// Convert a HIR expression to Rust tokens
///
/// # Arguments
/// * `expr` - The HIR expression to convert
/// * `ctx` - Code generation context
///
/// # Returns
/// A `TokenStream` representing the Rust equivalent
///
/// # Examples
/// ```rust
/// let expr = HirExpr::Literal(Literal::Int(42));
/// let tokens = expr.to_rust_expr(&mut ctx)?;
/// ```
pub fn literal_to_rust_expr(expr: &HirExpr, ctx: &mut CodeGenContext) -> Result<TokenStream> {
    // ...
}
```

### Project Documentation

**Files to Update**:
- [ ] `CHANGELOG.md` - Add v3.18.0 section
- [ ] `docs/execution/roadmap.md` - Update with v3.18.0 status
- [ ] `README.md` - Update architecture diagram (if exists)
- [ ] `CONTRIBUTING.md` - Update module structure guide

---

## Timeline & Milestones

### Estimated Timeline

| Phase | Description | Estimated Time | Completion Target |
|-------|-------------|----------------|-------------------|
| 1 | Planning & Setup | ✅ Complete | 2025-10-10 |
| 2 | Extract pure functions | 2-3 hours | Day 1 |
| 3 | Extract context & imports | 1-2 hours | Day 1 |
| 4 | Extract generator support | 2 hours | Day 1-2 |
| 5 | Extract expression codegen | 3-4 hours | Day 2 |
| 6 | Extract statement codegen | 2-3 hours | Day 2-3 |
| 7 | Extract function codegen | 2-3 hours | Day 3 |
| 8 | Final integration | 1-2 hours | Day 3 |
| **TOTAL** | **Execution + Testing** | **13-19 hours** | **3-4 days** |

### Milestones

**Milestone 1**: Pure Functions Extracted (Phase 2 Complete)
- format.rs, error_gen.rs, type_gen.rs created
- All tests passing

**Milestone 2**: Infrastructure Ready (Phases 2-3 Complete)
- context.rs, import_gen.rs added
- Module structure established

**Milestone 3**: Specialized Logic Isolated (Phase 4 Complete)
- generator_gen.rs extracted
- Generator tests passing

**Milestone 4**: Expression Codegen Modularized (Phase 5 Complete) 🎯 HIGH RISK
- expr_gen.rs created (~1800 LOC)
- All expression tests passing
- Performance validated

**Milestone 5**: Statement Codegen Modularized (Phase 6 Complete)
- stmt_gen.rs created
- All statement tests passing

**Milestone 6**: Function Codegen Modularized (Phase 7 Complete)
- function_gen.rs created
- All function tests passing

**Milestone 7**: v3.18.0 Complete (Phase 8 Complete) 🎉
- mod.rs created, old rust_gen.rs removed
- ALL tests passing, zero warnings
- Documentation updated
- Ready for release

---

## Release Checklist

### Pre-Release Validation

**Functional**:
- [ ] All 735+ tests pass (`cargo test --workspace`)
- [ ] All showcase examples compile (`rustc --crate-type lib examples/showcase/*.rs`)
- [ ] Zero clippy warnings (`cargo clippy --all-targets -- -D warnings`)

**Quality**:
- [ ] All modules grade A- or higher (`pmat tdg crates/depyler-core/src/rust_gen`)
- [ ] All functions complexity ≤10 (`pmat analyze complexity --max-cyclomatic 10`)
- [ ] Zero SATD violations (`pmat analyze satd --fail-on-violation`)
- [ ] Coverage maintained ≥62.93% (`make coverage`)

**Performance**:
- [ ] Transpilation time within 5% of baseline (`cargo bench`)
- [ ] Memory usage within 10% of baseline

**Documentation**:
- [ ] CHANGELOG.md updated
- [ ] Roadmap updated
- [ ] Module docs complete
- [ ] Migration guide written (for contributors)

### Release Process

**Version Bump**:
```bash
# Update workspace Cargo.toml
version = "3.18.0"

# Update all crate dependencies
find crates/*/Cargo.toml -exec sed -i 's/version = "3.17.0"/version = "3.18.0"/g' {} \;
```

**Git Operations**:
```bash
git checkout main
git merge v3.18.0-phase8-final-integration
git tag -a v3.18.0 -m "v3.18.0 - Transpiler Modularization"
git push origin main --tags
```

**Publish to crates.io**:
```bash
# In dependency order
cd crates/depyler-annotations && cargo publish
cd ../depyler-core && cargo publish
cd ../depyler-analyzer && cargo publish
cd ../depyler-verify && cargo publish
cd ../depyler-mcp && cargo publish
cd ../depyler-quality && cargo publish
cd ../depyler-ruchy && cargo publish --features=interpreter
cd ../depyler-wasm && cargo publish
cd ../depyler && cargo publish
```

---

## Success Metrics

### Code Quality Metrics

**Before** (v3.17.0):
- rust_gen.rs: 4,927 lines, monolithic
- Estimated avg complexity: 8-12 per function
- Some functions >100 complexity (already refactored in v3.17.0)

**After** (v3.18.0 Target):
- 10 focused modules, avg ~510 LOC each
- All functions complexity ≤10
- All modules grade A- or higher
- Clear separation of concerns

### Functional Metrics

**Test Coverage**:
- Before: 735 tests passing, 62.93% coverage
- After: 735+ tests passing, ≥62.93% coverage

**Performance**:
- Transpilation time: Within 5% of baseline
- Memory usage: Within 10% of baseline

### Maintainability Metrics

**Clarity**:
- Each module has single, clear responsibility
- No circular dependencies
- Well-documented public APIs

**Extensibility**:
- New expression types: Add to expr_gen.rs only
- New statement types: Add to stmt_gen.rs only
- New type conversions: Add to type_gen.rs only

---

## Conclusion

This plan provides a comprehensive, step-by-step guide to safely modularizing rust_gen.rs into 10 focused modules while maintaining 100% functionality and test coverage.

**Key Success Factors**:
1. **Incremental approach**: 8 phases with testing at each step
2. **Risk mitigation**: Rollback procedures, safety branches, comprehensive validation
3. **Quality enforcement**: PMAT gates, complexity limits, coverage maintenance
4. **Clear milestones**: 7 milestones with specific deliverables

**Estimated Effort**: 13-19 hours execution + 2-3 hours planning/docs = **15-22 hours total**

**Target Completion**: 3-4 days (with proper testing and validation)

---

**Document Status**: ✅ Ready for Implementation
**Next Step**: Begin Phase 2 - Extract Pure Functions
**Approval Required**: Yes (before starting Phase 2)

---

**END OF DOCUMENT**
