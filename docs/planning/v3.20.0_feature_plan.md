# v3.20.0 Feature Work Plan - New Capabilities

**Goal**: Add high-value features that expand transpiler capabilities
**Approach**: Prioritize Python features with high user demand and clear Rust equivalents
**Duration**: 2-3 weeks
**Focus**: Production readiness and real-world usability

## Feature Priorities (Based on User Impact)

### Priority 1: Core Language Features (Week 1)

#### 1.1 F-Strings Support (DEPYLER-0165)
**Status**: Known limitation from v3.18.2 emergency sprint
**Impact**: HIGH - F-strings are ubiquitous in modern Python
**Effort**: 12-16 hours
**Complexity**: Medium

**Implementation**:
- Parse f-string components (literals, expressions, format specs)
- Generate equivalent `format!()` or `write!()` macros
- Handle nested expressions and format specifiers
- Support conversion flags (!r, !s, !a)

**Test Coverage**:
- Simple f-strings: `f"Hello {name}"`
- Format specs: `f"Value: {x:.2f}"`
- Nested expressions: `f"Result: {calc(a, b)}"`
- Multiple variables: `f"{first} {last}"`

**Success Criteria**:
✅ All f-string patterns transpile correctly
✅ Generated `format!()` macros compile
✅ Format specifiers map to Rust equivalents
✅ 20+ test cases covering edge cases

#### 1.2 Match Statements (Python 3.10+) (DEPYLER-0166)
**Impact**: HIGH - Pattern matching is a killer feature
**Effort**: 16-20 hours
**Complexity**: High

**Implementation**:
- Parse Python match/case statements
- Generate Rust match expressions
- Handle pattern matching (literals, bindings, guards)
- Support wildcard patterns (_)
- Handle OR patterns (|)

**Test Coverage**:
- Literal matching: `case 1: ...`
- Binding: `case x: ...`
- Guards: `case x if x > 0: ...`
- OR patterns: `case 1 | 2 | 3: ...`

**Success Criteria**:
✅ Match statements transpile to Rust match
✅ All pattern types supported
✅ Guards map to match arms with if
✅ 15+ test cases

#### 1.3 Walrus Operator (:=) (DEPYLER-0167)
**Impact**: MEDIUM - Useful for concise code
**Effort**: 4-6 hours
**Complexity**: Low

**Implementation**:
- Parse assignment expressions (`:=`)
- Generate equivalent Rust let bindings
- Handle scope correctly (expression context)

**Success Criteria**:
✅ Walrus operator transpiles correctly
✅ Scoping rules preserved
✅ 8+ test cases

### Priority 2: Type System Enhancements (Week 2)

#### 2.1 TypedDict Support (DEPYLER-0168)
**Impact**: MEDIUM - Better type safety for dicts
**Effort**: 8-10 hours
**Complexity**: Medium

**Implementation**:
- Parse TypedDict definitions
- Generate struct types with serde support
- Handle required/optional fields
- Support inheritance

**Success Criteria**:
✅ TypedDict → struct with proper types
✅ Serde serialization/deserialization
✅ 12+ test cases

#### 2.2 Protocol Support (Structural Subtyping) (DEPYLER-0169)
**Impact**: MEDIUM - Interfaces without inheritance
**Effort**: 10-12 hours
**Complexity**: High

**Implementation**:
- Parse Protocol definitions
- Generate Rust traits
- Handle protocol checking
- Support generic protocols

**Success Criteria**:
✅ Protocol → trait definitions
✅ Structural subtyping validated
✅ 10+ test cases

### Priority 3: Standard Library Equivalents (Week 2-3)

#### 3.1 collections Module (DEPYLER-0170)
**Impact**: HIGH - Common Python patterns
**Effort**: 12-16 hours
**Complexity**: Medium

**Modules to Support**:
- `collections.Counter` → Custom struct with HashMap
- `collections.deque` → VecDeque
- `collections.defaultdict` → HashMap with closure
- `collections.namedtuple` → struct with field names

**Success Criteria**:
✅ 4 collection types supported
✅ API compatibility maintained
✅ 20+ test cases

#### 3.2 itertools Module (DEPYLER-0171)
**Impact**: MEDIUM - Powerful iteration utilities
**Effort**: 8-12 hours
**Complexity**: Medium

**Functions to Support**:
- `itertools.chain` → Iterator::chain
- `itertools.zip_longest` → Custom iterator
- `itertools.groupby` → Custom iterator
- `itertools.product` → Nested iterators

**Success Criteria**:
✅ 6-8 itertools functions supported
✅ Zero-cost abstractions
✅ 15+ test cases

### Priority 4: Error Handling Improvements (Week 3)

#### 4.1 Custom Exception Types (DEPYLER-0172)
**Impact**: MEDIUM - Better error modeling
**Effort**: 6-8 hours
**Complexity**: Medium

**Implementation**:
- Parse custom exception class definitions
- Generate custom Error types with thiserror
- Handle exception hierarchy
- Support error messages and data

**Success Criteria**:
✅ Custom exceptions → Error types
✅ thiserror derive macros
✅ 10+ test cases

#### 4.2 Context Managers (with statement) Enhancements (DEPYLER-0173)
**Impact**: MEDIUM - Resource management
**Effort**: 8-10 hours
**Complexity**: Medium

**Implementation**:
- Better codegen for `with` statements
- Generate RAII patterns
- Support multiple context managers
- Handle exceptions in context

**Success Criteria**:
✅ with statement → RAII drop
✅ Multiple managers supported
✅ 12+ test cases

## v3.20.0 Feature Summary

| Feature | Priority | Effort | Impact | Complexity |
|---------|----------|--------|--------|------------|
| F-Strings | P1 | 12-16h | HIGH | Medium |
| Match Statements | P1 | 16-20h | HIGH | High |
| Walrus Operator | P1 | 4-6h | MEDIUM | Low |
| TypedDict | P2 | 8-10h | MEDIUM | Medium |
| Protocol | P2 | 10-12h | MEDIUM | High |
| collections | P3 | 12-16h | HIGH | Medium |
| itertools | P3 | 8-12h | MEDIUM | Medium |
| Custom Exceptions | P4 | 6-8h | MEDIUM | Medium |
| Context Managers | P4 | 8-10h | MEDIUM | Medium |

**Total Effort**: 84-104 hours (~2-3 weeks)
**Features**: 9 major capabilities
**Expected Impact**: HIGH (doubles useful Python subset)

## Success Criteria

✅ All 9 features implemented
✅ 122+ new tests (comprehensive coverage)
✅ All quality gates passing (clippy, coverage, complexity)
✅ Documentation updated with new capabilities
✅ Examples showcase new features
✅ Zero regressions on existing functionality

## Toyota Way Alignment

- **Jidoka**: Build quality in (tests for every feature)
- **Kaizen**: Incremental feature additions (week by week)
- **Genchi Genbutsu**: Test with real-world Python code
- **Hansei**: Review which features users actually need

## Release Strategy

- **v3.20.0-alpha.1**: P1 features (f-strings, match, walrus)
- **v3.20.0-alpha.2**: P2 features (TypedDict, Protocol)
- **v3.20.0-beta.1**: P3 features (collections, itertools)
- **v3.20.0**: Final release with all features + polish
