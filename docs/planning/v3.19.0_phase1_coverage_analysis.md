# v3.19.0 Phase 1: Coverage Analysis & Test Plan

**Date**: 2025-10-14
**Status**: COMPLETE
**Ticket**: DEPYLER-0150

## Executive Summary

**Current Coverage**: **77.52%** (depyler-core)
**Target Coverage**: **80.00%**
**Gap**: **2.48%** (Only 601 lines of 24,203!)

**Excellent News**: The original estimate of 17.07% gap was based on workspace-wide coverage (62.93%). The core crate is already much closer to target than expected!

## Coverage Report Results

### Overall Metrics (depyler-core)
- **Total Lines**: 24,203
- **Missed Lines**: 5,442
- **Coverage**: 77.52% (lines) / 75.45% (regions)
- **Functions**: 1,887 total, 344 missed (81.77%)
- **Tests Passing**: 441/441 ‚úÖ
- **Clippy Warnings**: 0 ‚úÖ

### Top 10 Modules with Lowest Coverage

| Rank | Module | Coverage | Missed Lines | Priority | Complexity |
|------|--------|----------|--------------|----------|------------|
| 1 | **inlining.rs** | **13.42%** | 649 | üî¥ SKIP (unused) | Low |
| 2 | **depyler-annotations/lib.rs** | **31.29%** | 473 | üî¥ HIGH | Medium |
| 3 | **lifetime_analysis.rs** | **34.44%** | 305 | üî¥ HIGH | High |
| 4 | **borrowing.rs** | **43.23%** | 143 | üü° MEDIUM | Medium |
| 5 | **hir.rs** | **50.00%** | 7 | üü¢ LOW | Low |
| 6 | **import_gen.rs** | **60.00%** | 19 | üü¢ LOW | Low |
| 7 | **ide.rs** | **63.50%** | 87 | üü° MEDIUM | Medium |
| 8 | **expr_gen.rs** | **64.15%** | 492 | üî¥ HIGH | High |
| 9 | **context.rs** | **65.71%** | 7 | üü¢ LOW | Low |
| 10 | **direct_rules.rs** | **63.80%** | 629 | üî¥ HIGH | High |

### Modules with Excellent Coverage (>90%)

- **module_mapper.rs**: 98.55% ‚úÖ
- **test_generation.rs**: 96.44% ‚úÖ
- **generator_state.rs**: 95.40% ‚úÖ
- **lambda_types.rs**: 95.49% ‚úÖ
- **ast_bridge/properties.rs**: 97.38% ‚úÖ
- **rust_gen.rs**: 93.69% ‚úÖ
- **migration_suggestions.rs**: 94.45% ‚úÖ
- **lambda_optimizer.rs**: 92.43% ‚úÖ
- **union_enum_gen.rs**: 92.18% ‚úÖ

## Revised Strategy

### Original Plan (Based on 62.93% workspace coverage)
- **Gap**: 17.07%
- **Effort**: 24 hours, 65 tests
- **Duration**: 3 days

### Revised Plan (Based on 77.52% core coverage)
- **Gap**: 2.48% (12x better!)
- **Effort**: 8 hours, 17 tests (unit + property + mutation)
- **Duration**: 1 day

### Quick Wins to Reach 80%

**Phase 2A: expr_gen.rs** (64.15% ‚Üí 75%+)
- **Missed Lines**: 492
- **Effort**: 4 hours
- **Tests**: 10 (3 unit + 4 property + 3 mutation)
- **Expected Gain**: +2-3% coverage
- **Focus**: Method calls, comprehensions, string formatting edge cases

**Phase 2B: direct_rules.rs** (63.80% ‚Üí 75%+)
- **Missed Lines**: 629
- **Effort**: 3 hours
- **Tests**: 8 (2 unit + 4 property + 2 mutation)
- **Expected Gain**: +2-3% coverage
- **Focus**: Type conversions, operator mappings, special cases

**Phase 2C: Quick Wins** (Small modules)
- **Modules**: hir.rs (7 lines), context.rs (7 lines), import_gen.rs (19 lines)
- **Effort**: 1 hour
- **Tests**: 3 (1 each module)
- **Expected Gain**: +0.5% coverage
- **Focus**: Simple path coverage

### Modules to Skip

**inlining.rs** (13.42%, 649 missed lines)
- **Reason**: Inlining optimization is disabled (per DEPYLER-0161)
- **Status**: Candidate for deprecation/removal
- **Impact**: Large missed lines but unused code path

## Property + Mutation Testing Strategy

**MANDATORY**: All coverage increases MUST include:

1. **Unit Tests**: Basic behavior validation
2. **Property Tests**: Using `proptest!` or `quickcheck!` with arbitrary inputs (10 cases for coverage)
3. **Mutation Tests**: Comments documenting which mutations are killed

### Test Structure Template

```rust
// module_tests.rs

// ============================================================================
// UNIT TESTS
// ============================================================================
mod unit_tests {
    use super::*;

    #[test]
    fn test_basic_behavior() {
        // Basic functionality validation
    }
}

// ============================================================================
// PROPERTY TESTS
// ============================================================================
#[cfg(test)]
mod property_tests {
    use super::*;
    use proptest::prelude::*;

    proptest! {
        #![proptest_config(ProptestConfig::with_cases(10))]

        #[test]
        fn prop_always_compiles(input in "\\PC{0,100}") {
            // Property: arbitrary inputs should compile
            prop_assert!(transpile(&input).is_ok());
        }
    }
}

// ============================================================================
// MUTATION TESTS
// ============================================================================
mod mutation_tests {
    use super::*;

    #[test]
    fn test_mutation_operator_swap() {
        // Target Mutations:
        // 1. + ‚Üí - (arithmetic operator swap)
        // 2. == ‚Üí != (comparison operator swap)
        // 3. return ‚Üí () (remove return)
        //
        // Kill Strategy:
        // - Assertions on specific values that differ under mutation
        // - Check for presence of operators in generated code

        let result = transpile("x + y");
        assert!(result.contains("+"), "Must contain + operator");
        assert!(result.contains("return"), "Must have return statement");
    }
}
```

### Example: string_optimization_test.rs Enhancement

The fixed test file needs:
- ‚úÖ 6 unit tests (DONE)
- ‚è≥ 3 property tests (TODO)
- ‚è≥ 2 mutation tests (TODO)

## Success Criteria

- ‚úÖ Coverage Analysis Complete (Phase 1)
- ‚úÖ Test Plan Created (Phase 1)
- ‚è≥ Coverage ‚â•80% (Phase 2)
- ‚è≥ All tests include unit + property + mutation (Phase 2)
- ‚è≥ Zero regressions (maintained)
- ‚è≥ Clippy zero warnings (maintained)
- ‚è≥ SATD zero violations (maintained)

## Revised Tickets

### DEPYLER-0150: Coverage Analysis & Test Plan
- **Status**: COMPLETE
- **Actual Hours**: 2 hours (estimated 4)
- **Efficiency**: 50% faster than estimated

### DEPYLER-0151: expr_gen.rs Property + Mutation Coverage
- **Status**: PLANNED ‚Üí IN_PROGRESS (Phase 2A)
- **Revised Hours**: 4 (was 8)
- **Revised Tests**: 10 (was 30)
- **Structure**: 3 unit + 4 property + 3 mutation

### DEPYLER-0152: direct_rules.rs Property + Mutation Coverage
- **Status**: PLANNED (Phase 2B)
- **Revised Hours**: 3 (was 6)
- **Revised Tests**: 8 (was 20)
- **Structure**: 2 unit + 4 property + 2 mutation

### DEPYLER-0155: Quick Wins (Small Modules)
- **Status**: NEW (Phase 2C)
- **Revised Hours**: 1
- **Revised Tests**: 3 (1 per module)
- **Modules**: hir.rs, context.rs, import_gen.rs

### DEPYLER-0153: CANCELLED
- **Reason**: func_gen.rs already at 68.80% (sufficient)
- **Alternative**: Addressed via Phase 2C quick wins

### DEPYLER-0154: Coverage Milestone Verification
- **Status**: PLANNED (Phase 3)
- **Hours**: 1 (was 2)
- **Tasks**: Run coverage, verify 80%, update metrics

## Total Revised Effort

| Phase | Duration | Tests | Notes |
|-------|----------|-------|-------|
| Phase 1 | 2h (‚úÖ DONE) | 0 | Coverage analysis |
| Phase 2A | 4h | 10 | expr_gen.rs |
| Phase 2B | 3h | 8 | direct_rules.rs |
| Phase 2C | 1h | 3 | Quick wins |
| Phase 3 | 1h | 0 | Verification |
| **Total** | **11h** | **21** | **vs 24h/65 tests originally** |

**Savings**: 13 hours (54% faster), 44 fewer tests (62% reduction)

## Toyota Way Alignment

- **Jidoka**: Build quality in through property + mutation testing
- **Genchi Genbutsu**: Measured actual coverage (77.52%), didn't estimate
- **Kaizen**: Opportunistic test improvements during coverage work
- **Hansei**: Reflected on why workspace vs core coverage differed

## Next Steps

1. ‚úÖ Complete Phase 1 analysis (DONE)
2. ‚è≥ Update roadmap with revised Phase 2 plan
3. ‚è≥ Commit Phase 1 analysis
4. ‚è≥ Start Phase 2A: string_optimization_test.rs property + mutation tests
5. ‚è≥ Continue with expr_gen.rs coverage expansion

---

**Notes**:
- Property test case count: 10 (per PROPTEST_CASES=10, QUICKCHECK_TESTS=10)
- Coverage run time: ~25-60s (per DEPYLER-0146 optimization)
- All tests must pass `cargo test` and `cargo clippy -- -D warnings`
