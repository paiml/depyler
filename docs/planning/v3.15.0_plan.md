# v3.15.0 Release Plan - Showcase Completion & Type System Enhancements

**Release Date**: TBD (2-3 weeks from 2025-10-10)
**Status**: PLANNING
**Focus**: Type System Correctness > Showcase 100% > Security

## Strategic Goals

**Primary**: Fix critical type inference bugs blocking showcase examples
**Secondary**: Achieve 6/6 showcase examples compiling cleanly
**Tertiary**: Address remaining security vulnerability (slab v0.4.10)

## Success Criteria

**Must Have** (P0):
- [ ] 6/6 showcase examples compile with 0 warnings (currently 4/6)
- [ ] Numeric literal type inference works correctly (f64 context)
- [ ] String method return types correct (String vs &str)
- [ ] All 408+ tests passing (100% maintained)

**Should Have** (P1):
- [ ] fnv dependency resolution (add to workspace or use std)
- [ ] slab vulnerability resolved (upstream fix or workaround)
- [ ] Zero clippy warnings across all showcase examples

**Nice to Have** (P2):
- [ ] Cow import optimization (only when actually used)
- [ ] Additional showcase examples (async/await, with statements)
- [ ] Performance improvements for generated code

## Phases

### Phase 1: Critical Type Inference Fixes (Week 1)

**DEPYLER-TBD (P0)**: Numeric Type Inference
- **Problem**: `let mut total = 0` inferred as i32, but should be f64 when used with f64 values
- **Files Affected**: contracts_example.rs, annotated_example.rs (2/6 examples blocked)
- **Fix**: In `rust_gen.rs` or `type_mapper.rs`:
  - Detect when variable is assigned from typed context (f64)
  - Generate `0.0` for float literals in float context
  - Or add explicit type annotation: `let mut total: f64 = 0.0;`
- **Test**: Re-transpile contracts_example.py and verify compilation
- **Effort**: 4-6 hours

**DEPYLER-TBD (P0)**: String Method Return Types
- **Problem**: `text.to_uppercase()` returns `String`, but function signature expects `&str`
- **Files Affected**: annotated_example.rs (1/6 examples blocked)
- **Fix**: In `rust_gen.rs`:
  - Recognize Python string methods that return new strings
  - Generate `String` return type, not `&'a str`
  - Methods: `.upper()`, `.lower()`, `.title()`, `.capitalize()`, etc.
- **Test**: Re-transpile annotated_example.py and verify compilation
- **Effort**: 3-4 hours

### Phase 2: Dependency & Security (Week 2)

**DEPYLER-TBD (P1)**: FnvHashMap Dependency
- **Problem**: Generated code uses `fnv::FnvHashMap` but fnv not in dependencies
- **Files Affected**: annotated_example.rs (1/6 examples blocked)
- **Fix Option A**: Add fnv to workspace dependencies
  ```toml
  fnv = "1.0"
  ```
- **Fix Option B**: Use std::collections::HashMap instead
- **Decision**: Use Option B (fewer dependencies)
- **Test**: Re-transpile annotated_example.py without fnv import
- **Effort**: 2-3 hours

**SECURITY (P1)**: Resolve slab v0.4.10 Vulnerability
- **Problem**: CVE-2025-55159, waiting for upstream pmcp/pmat fix
- **Current Status**: Documented, low risk (function not in code paths)
- **Options**:
  1. Wait for pmcp/pmat upstream update (recommended)
  2. Fork and patch locally (high maintenance)
  3. Replace pmcp/pmat (large effort)
- **Action**: Monitor upstream, update when available
- **Effort**: 1 hour (monitoring + update when ready)

### Phase 3: Quality & Documentation (Week 3)

**DEPYLER-TBD (P2)**: Optimize Cow Import Detection
- **Problem**: `use std::borrow::Cow` added even when not used
- **Files Affected**: classify_number.rs (1 warning)
- **Fix**: Refine lifetime analysis to only set `ctx.needs_cow` when generating `Cow<'a, T>` types
- **Test**: Re-transpile classify_number.py and verify no import
- **Effort**: 2-3 hours

**DEPYLER-TBD (P2)**: Add Showcase Examples
- **Goal**: Demonstrate validated features (async/await, with statements)
- **Examples**:
  - `examples/showcase/async_example.py` - Async patterns
  - `examples/showcase/with_example.py` - Context managers
- **Validation**: Both must transpile and compile cleanly
- **Effort**: 3-4 hours

## Key Metrics

| Metric | Baseline (v3.14.0) | Target (v3.15.0) |
|--------|-------|---------|
| Showcase Transpile | 6/6 (100%) | 6/6 (100%) |
| Showcase Compile | 4/6 (67%) | 6/6 (100%) |
| Showcase Warnings | 1 | 0 |
| Tests | 408 | 420+ |
| Security Vulnerabilities | 1 documented | 0 (if upstream fixed) |
| Clippy Warnings (Generated) | 0 (4/6 files) | 0 (6/6 files) |

## Implementation Strategy

### Week 1: Type Inference Fixes
1. Day 1-2: Numeric type inference (contracts_example)
2. Day 3-4: String return types (annotated_example)
3. Day 5: Re-transpile all showcase, validate 5/6 or 6/6 compiling

### Week 2: Dependencies & Security
4. Day 6-7: fnv dependency resolution
5. Day 8: Security monitoring/update
6. Day 9: Re-transpile, validate 6/6 compiling cleanly

### Week 3: Quality & Release
7. Day 10-11: Cow import optimization
8. Day 12-13: Add new showcase examples
9. Day 14: Final validation, documentation, release

## Testing Strategy

**For Each Fix**:
1. Write failing test case first (TDD)
2. Implement fix in transpiler
3. Run unit tests: `cargo test --workspace`
4. Re-transpile ALL 6 showcase examples
5. Compile each with `rustc --crate-type lib <file.rs> --deny warnings`
6. Verify zero warnings, zero errors
7. Run quality gates: `make lint`

**Final Validation**:
```bash
# All tests pass
cargo test --workspace  # 420+ tests

# All showcase examples compile cleanly
for file in examples/showcase/*.rs; do
    rustc --crate-type lib "$file" --deny warnings || exit 1
done

# Zero security vulnerabilities
cargo audit

# Quality gates pass
make lint
pmat quality-gate --fail-on-violation
```

## Risk Mitigation

**Technical Risks**:
- Type inference changes may break existing code
  - Mitigation: Comprehensive test suite (408+ tests) provides safety net
  - Fallback: Feature flag for new type inference

**Schedule Risks**:
- Upstream slab fix may not arrive in time
  - Mitigation: Phase 2 is not blocking, can defer to v3.16.0
  - Impact: 5/6 compiling is still strong improvement

**Scope Risks**:
- Type system fixes may reveal more issues
  - Mitigation: Strict P0/P1/P2 prioritization
  - Decision: Release with 5/6 if critical issues arise

## Dependencies

- v3.14.0 released ✅
- Phase 5 validation complete ✅
- Security analysis complete ✅
- Showcase issue analysis complete ✅

## Breaking Changes

None expected - fixes are corrections to incorrect code generation.

## Migration Guide

No migration needed - generated code will be more correct.

## Success Definition

v3.15.0 is successful if:
1. ✅ 6/6 showcase examples compile with zero warnings
2. ✅ All P0 type inference bugs fixed
3. ✅ Test count maintained or increased (420+)
4. ✅ Zero regressions in existing functionality
5. ✅ Documentation updated with new capabilities

**Release Readiness**: When all P0 criteria met + 90%+ of P1 criteria met
